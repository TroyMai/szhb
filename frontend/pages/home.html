<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¦–é¡µ - æ•°æ™ºæ¹–åŒ—</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="../public/css/common.css">
    <link rel="stylesheet" href="../public/css/cards.css">
    <link rel="stylesheet" href="../public/css/footer.css">
</head>
<body class="bg-gray-50">
    <!-- å¯¼èˆªæ  -->
    <div id="header"></div>

    <!-- ä¸»è¦å†…å®¹ -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- åŠŸèƒ½å¯¼èˆªå¡ç‰‡ -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8" id="funcCards">
                <a href="./query.html" class="func-card func-card-green" data-route="query">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-800">æ•°æ®æŸ¥è¯¢</h3>
                        <div class="text-3xl">ğŸ”</div>
                    </div>
                    <p class="text-gray-600 text-sm">å¤šæ¡ä»¶ç»„åˆæŸ¥è¯¢æ•°æ®</p>
                </a>
                
                <a href="./prediction.html" class="func-card func-card-purple" data-route="prediction">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-800">æ•°æ®é¢„æµ‹</h3>
                        <div class="text-3xl">ğŸ“ˆ</div>
                    </div>
                    <p class="text-gray-600 text-sm">åŸºäºå†å²æ•°æ®é¢„æµ‹æœªæ¥è¶‹åŠ¿</p>
                </a>
                
                <a href="./analysis.html" class="func-card func-card-orange" data-route="analysis">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-800">å†³ç­–æ”¯æŒ</h3>
                        <div class="text-3xl">ğŸ’¡</div>
                    </div>
                    <p class="text-gray-600 text-sm">é—®é¢˜åˆ†æä¸è¾…åŠ©å†³ç­–</p>
                </a>
            </div>

        <!-- ç³»ç»Ÿæ•°æ®ç»Ÿè®¡ -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <!-- æ•°æ®åˆ†ç±»ç»Ÿè®¡ -->
            <div class="stat-card">
                <h2 class="stat-card-title">æ•°æ®åˆ†ç±»ç»Ÿè®¡</h2>
                <div id="categoryStats" class="grid grid-cols-2 gap-2">
                    <div class="stat-item stat-item-indigo">
                        <span class="text-gray-700">åŠ è½½ä¸­...</span>
                    </div>
                </div>
            </div>

            <!-- æ•°æ®æ¥æºç»Ÿè®¡ -->
            <div class="stat-card">
                <h2 class="stat-card-title">æ•°æ®æ¥æºç»Ÿè®¡</h2>
                <div class="chart-container chart-container-sm">
                    <canvas id="sourceChart"></canvas>
                </div>
                <div id="sourceLegend" class="chart-legend"></div>
            </div>
        </div>

        <!-- æ•°æ®è¶‹åŠ¿å›¾è¡¨ -->
        <div class="stat-card">
            <h2 class="stat-card-title">æ•°æ®æ—¶é—´ç»Ÿè®¡</h2>
            <div class="chart-container chart-container-md">
                <canvas id="trendChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div id="footer"></div>

    <script type="module">
        import api from '../utils/api.js';
        import auth from '../utils/auth.js';
        import header from '../components/header.js';
        import footer from '../components/footer.js';

        // æ£€æŸ¥ç™»å½•çŠ¶æ€ï¼ˆä½¿ç”¨è·¯ç”±å®ˆå«ï¼‰
        const router = await import('../utils/router.js');
        router.default.beforeEnter('home');

        // æ›´æ–°åŠŸèƒ½å¡ç‰‡é“¾æ¥
        document.querySelectorAll('[data-route]').forEach(link => {
            const routeName = link.getAttribute('data-route');
            link.href = router.default.getPath(routeName);
        });

        // åˆå§‹åŒ–å¯¼èˆªæ 
        header.initHeader();
        
        // åˆå§‹åŒ– Footer
        footer.initFooter();

        // åŠ è½½æ•°æ®åˆ†ç±»ç»Ÿè®¡
        const loadCategoryStats = async () => {
            try {
                const response = await api.get('/data/stats/categories');
                const statsContainer = document.getElementById('categoryStats');
                
                if (response.success && response.data && response.data.length > 0) {
                    // é¢œè‰²æ˜ å°„ - ä½¿ç”¨ä¸åŒçš„é¢œè‰²ä½†ä¿æŒåè°ƒ
                    const colors = {
                        'ç§‘æŠ€åˆ›æ–°': 'blue',
                        'æ•™è‚²æ–‡åŒ–': 'green',
                        'ç¤¾ä¼šæ°‘ç”Ÿ': 'purple',
                        'ç”Ÿæ€ç¯å¢ƒ': 'cyan',
                        'æ°”è±¡æœåŠ¡': 'orange',
                        'å•†è´¸æµé€š': 'yellow',
                        'ç¤¾ä¿å°±ä¸š': 'pink',
                        'å¸‚åœºç›‘ç£': 'indigo',
                        'åŒ»ç–—å«ç”Ÿ': 'red',
                        'äº¤é€šè¿è¾“': 'teal'
                    };
                    
                    const textColors = {
                        'blue': 'text-blue-600',
                        'green': 'text-green-600',
                        'purple': 'text-purple-600',
                        'orange': 'text-orange-600',
                        'cyan': 'text-cyan-600',
                        'yellow': 'text-yellow-600',
                        'pink': 'text-pink-600',
                        'indigo': 'text-indigo-600',
                        'red': 'text-red-600',
                        'teal': 'text-teal-600'
                    };
                    
                    const router = await import('../utils/router.js');
                    statsContainer.innerHTML = response.data.map(cat => {
                        const color = colors[cat.category] || 'indigo';
                        const textColor = textColors[color] || 'text-indigo-600';
                        return `
                            <a href="${router.default.getPath('query', { category: cat.category })}" class="stat-item stat-item-${color}">
                                <span class="text-gray-700 font-medium">${cat.category}</span>
                                <span class="font-semibold ${textColor}">${cat.count}æ¡</span>
                            </a>
                        `;
                    }).join('');
                } else {
                    // ä½¿ç”¨é»˜è®¤æ•°æ®ï¼ˆAPI è¿”å›ç©ºæˆ–å¤±è´¥æ—¶ï¼‰
                    statsContainer.innerHTML = `
                        <div class="stat-item stat-item-indigo">
                            <span class="text-gray-700">æš‚æ— æ•°æ®</span>
                            <span class="font-semibold text-indigo-600">0æ¡</span>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
                // ä½¿ç”¨é»˜è®¤æ•°æ®
                document.getElementById('categoryStats').innerHTML = `
                    <div class="stat-item stat-item-gray">
                        <span class="text-gray-700">åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</span>
                        <span class="font-semibold text-gray-600">-</span>
                    </div>
                `;
            }
        };

        // åŠ è½½æ•°æ®è¶‹åŠ¿
        const loadTrendData = async () => {
            try {
                const response = await api.get('/data/stats/trend');
                if (response.success && response.data) {
                    initChart(response.data);
                } else {
                    // ä½¿ç”¨é»˜è®¤æ•°æ®
                    initChart(null);
                }
            } catch (error) {
                console.error('åŠ è½½è¶‹åŠ¿æ•°æ®å¤±è´¥:', error);
                // ä½¿ç”¨é»˜è®¤æ•°æ®
                initChart(null);
            }
        };

        // åˆå§‹åŒ–å›¾è¡¨
        let trendChart = null;
        const initChart = (trendData) => {
            const ctx = document.getElementById('trendChart').getContext('2d');
            
            // é”€æ¯æ—§å›¾è¡¨
            if (trendChart) {
                trendChart.destroy();
            }
            
            let labels = ['2020', '2021', '2022', '2023', '2024'];
            let data = [1200, 1500, 1800, 2100, 2400];
            
            if (trendData && trendData.length > 0) {
                labels = trendData.map(item => item.year.toString());
                data = trendData.map(item => item.count);
            }
            
            trendChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            type: 'bar',
                            label: 'æ•°æ®æ€»é‡',
                            data: data,
                            backgroundColor: 'rgba(99, 102, 241, 0.6)',
                            borderColor: 'rgb(99, 102, 241)',
                            borderWidth: 2,
                            borderRadius: 4,
                            order: 2
                        },
                        {
                            type: 'line',
                            label: 'è¶‹åŠ¿çº¿',
                            data: data,
                            borderColor: 'rgb(251, 146, 60)',
                            backgroundColor: 'rgba(251, 146, 60, 0.1)',
                            tension: 0.4,
                            fill: false,
                            pointRadius: 5,
                            pointHoverRadius: 7,
                            pointBackgroundColor: 'rgb(251, 146, 60)',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            order: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            filter: function(tooltipItem) {
                                // åªæ˜¾ç¤ºæŸ±çŠ¶å›¾çš„æ•°æ®ï¼Œéšè—æŠ˜çº¿å›¾çš„æ•°æ®
                                return tooltipItem.datasetIndex === 0;
                            },
                            callbacks: {
                                label: function(context) {
                                    return `${context.parsed.y} æ¡`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value + ' æ¡';
                                }
                            }
                        }
                    },
                    onClick: async (event, elements) => {
                        if (elements.length > 0) {
                            const router = await import('../utils/router.js');
                            const elementIndex = elements[0].index;
                            const year = labels[elementIndex];
                            // è·³è½¬åˆ°æŸ¥è¯¢é¡µé¢ï¼Œç­›é€‰å¯¹åº”å¹´ä»½
                            const startDate = `${year}-01-01`;
                            const endDate = `${year}-12-31`;
                            router.default.navigate('query', { startDate, endDate });
                        }
                    },
                    onHover: (event, elements) => {
                        event.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
                    }
                }
            });
        };

        // åŠ è½½æ•°æ®æ¥æºç»Ÿè®¡
        let sourceChart = null;
        const loadSourceStats = async () => {
            try {
                const response = await api.get('/data/stats/sources');
                const legendContainer = document.getElementById('sourceLegend');
                
                if (response.success && response.data && response.data.length > 0) {
                    const data = response.data;
                    
                    // å‡†å¤‡å›¾è¡¨æ•°æ®
                    const labels = data.map(item => item.source || 'æœªçŸ¥æ¥æº');
                    const values = data.map(item => item.count);
                    
                    // é¢œè‰²é…ç½®
                    const backgroundColors = [
                        'rgba(99, 102, 241, 0.8)',   // indigo
                        'rgba(34, 197, 94, 0.8)',    // green
                        'rgba(168, 85, 247, 0.8)',   // purple
                        'rgba(251, 146, 60, 0.8)',   // orange
                        'rgba(6, 182, 212, 0.8)',    // cyan
                        'rgba(139, 92, 246, 0.8)',   // indigo
                        'rgba(236, 72, 153, 0.8)',   // pink
                        'rgba(239, 68, 68, 0.8)',   // red
                        'rgba(20, 184, 166, 0.8)',   // teal
                        'rgba(234, 179, 8, 0.8)'     // yellow
                    ];
                    
                    const borderColors = [
                        'rgb(99, 102, 241)',
                        'rgb(34, 197, 94)',
                        'rgb(168, 85, 247)',
                        'rgb(251, 146, 60)',
                        'rgb(6, 182, 212)',
                        'rgb(139, 92, 246)',
                        'rgb(236, 72, 153)',
                        'rgb(239, 68, 68)',
                        'rgb(20, 184, 166)',
                        'rgb(234, 179, 8)'
                    ];
                    
                    // é”€æ¯æ—§å›¾è¡¨
                    if (sourceChart) {
                        sourceChart.destroy();
                    }
                    
                    // åˆ›å»ºé¥¼å›¾
                    const ctx = document.getElementById('sourceChart').getContext('2d');
                    sourceChart = new Chart(ctx, {
                        type: 'pie',
                        data: {
                            labels: labels,
                            datasets: [{
                                data: values,
                                backgroundColor: backgroundColors.slice(0, data.length),
                                borderColor: borderColors.slice(0, data.length),
                                borderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const label = context.label || '';
                                            const value = context.parsed || 0;
                                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                            const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                            return `${label}: ${value}æ¡ (${percentage}%)`;
                                        }
                                    }
                                }
                            },
                            onClick: async (event, elements) => {
                                if (elements.length > 0) {
                                    const router = await import('../utils/router.js');
                                    const elementIndex = elements[0].index;
                                    const source = labels[elementIndex];
                                    // è·³è½¬åˆ°æŸ¥è¯¢é¡µé¢ï¼Œç­›é€‰å¯¹åº”æ¥æº
                                    router.default.navigate('query', { source });
                                }
                            },
                            onHover: (event, elements) => {
                                event.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
                            }
                        }
                    });
                    
                    // æ˜¾ç¤ºå›¾ä¾‹
                    const router = await import('../utils/router.js');
                    legendContainer.innerHTML = data.map((item, index) => {
                        const color = backgroundColors[index % backgroundColors.length];
                        const total = values.reduce((a, b) => a + b, 0);
                        const percentage = total > 0 ? Math.round((item.count / total) * 100) : 0;
                        const source = item.source || 'æœªçŸ¥æ¥æº';
                        const queryPath = router.default.getPath('query', { source });
                        return `
                            <div class="chart-legend-item" onclick="window.location.href='${queryPath}'">
                                <div class="chart-legend-dot" style="background-color: ${color}"></div>
                                <span class="chart-legend-label" title="${source}">${source}</span>
                                <span class="chart-legend-value">${item.count}æ¡ (${percentage}%)</span>
                            </div>
                        `;
                    }).join('');
                } else {
                    legendContainer.innerHTML = `
                        <div class="text-center text-gray-500 text-sm">æš‚æ— æ•°æ®</div>
                    `;
                }
            } catch (error) {
                console.error('åŠ è½½æ¥æºç»Ÿè®¡å¤±è´¥:', error);
                document.getElementById('sourceLegend').innerHTML = `
                    <div class="text-center text-gray-500 text-sm">åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</div>
                `;
            }
        };

        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
        loadCategoryStats();
        loadSourceStats();
        loadTrendData();
    </script>
</body>
</html>

