<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>个人中心 - 数智湖北</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="../public/css/common.css">
    <link rel="stylesheet" href="../public/css/components.css">
    <link rel="stylesheet" href="../public/css/footer.css">
</head>
<body class="bg-gray-50">
    <div id="header"></div>
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- 返回首页按钮 -->
        <div id="backButtonContainer"></div>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-1">
                <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                    <div class="text-center">
                        <div id="userAvatar" class="w-24 h-24 bg-indigo-600 rounded-full mx-auto mb-4 flex items-center justify-center text-white text-3xl">用</div>
                        <h2 id="userName" class="text-xl font-bold text-gray-800 mb-1">加载中...</h2>
                        <p id="userEmail" class="text-sm text-gray-600 mb-4">加载中...</p>
                        <div id="userRole" class="inline-block px-4 py-2 bg-indigo-100 text-indigo-700 rounded-full text-sm font-semibold">普通用户</div>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">快捷操作</h3>
                    <div class="space-y-2">
                        <button onclick="scrollToSection('favorites')" class="w-full text-left px-4 py-3 bg-gray-50 hover:bg-gray-100 rounded-lg transition">
                            <div class="font-medium text-gray-800">我的收藏</div>
                            <div class="text-sm text-gray-600">查看收藏的数据</div>
                        </button>
                        <button onclick="scrollToSection('logs')" class="w-full text-left px-4 py-3 bg-gray-50 hover:bg-gray-100 rounded-lg transition">
                            <div class="font-medium text-gray-800">使用记录</div>
                            <div class="text-sm text-gray-600">查询与导出记录</div>
                        </button>
                        <button onclick="scrollToSection('profile')" class="w-full text-left px-4 py-3 bg-gray-50 hover:bg-gray-100 rounded-lg transition">
                            <div class="font-medium text-gray-800">个人信息</div>
                            <div class="text-sm text-gray-600">编辑个人资料</div>
                        </button>
                        <button onclick="scrollToSection('password')" class="w-full text-left px-4 py-3 bg-gray-50 hover:bg-gray-100 rounded-lg transition">
                            <div class="font-medium text-gray-800">修改密码</div>
                            <div class="text-sm text-gray-600">更新账户密码</div>
                        </button>
                    </div>
                </div>
            </div>
            <div class="lg:col-span-2">
                <div id="favorites" class="bg-white rounded-lg shadow-md p-6 mb-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-6">我的收藏</h2>
                    <div id="favoritesList" class="space-y-4">
                        <div class="text-center text-gray-500 py-8">加载中...</div>
                    </div>
                    <!-- 收藏分页 -->
                    <div id="favoritesPagination"></div>
                </div>
                <div id="logs" class="bg-white rounded-lg shadow-md p-6 mb-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-6">使用记录</h2>
                    <div id="logsList" class="space-y-4"></div>
                </div>
                <div id="profile" class="bg-white rounded-lg shadow-md p-6 mb-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-6">个人信息</h2>
                    <form id="profileForm" class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">用户名</label>
                                <input type="text" id="username" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" disabled>
                                <p class="text-xs text-gray-500 mt-1">用户名不可修改</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">邮箱</label>
                                <input type="email" id="email" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">手机号</label>
                                <input type="tel" id="phone" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">真实姓名</label>
                                <input type="text" id="real_name" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                            </div>
                        </div>
                        <div class="flex justify-end">
                            <button type="submit" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">保存修改</button>
                        </div>
                    </form>
                </div>
                <div id="password" class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-6">修改密码</h2>
                    <form id="passwordForm" class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">当前密码</label>
                            <input type="password" id="currentPassword" placeholder="请输入当前密码" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">新密码</label>
                            <input type="password" id="newPassword" placeholder="请输入新密码（至少8位，包含字母和数字）" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                            <p class="text-xs text-gray-500 mt-1">密码需包含大小写字母、数字，长度8-20位</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">确认新密码</label>
                            <input type="password" id="confirmPassword" placeholder="请再次输入新密码" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div class="flex justify-end">
                            <button type="submit" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">修改密码</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div id="footer"></div>

    <script type="module">
        import api from '../utils/api.js';
        import auth from '../utils/auth.js';
        import header from '../components/header.js';
        import common from '../utils/common.js';
        import backButton from '../components/backButton.js';
        import footer from '../components/footer.js';
        import favoriteButton from '../components/favoriteButton.js';
        import pagination from '../components/pagination.js';
        // 检查登录状态（使用路由守卫）
        const router = await import('../utils/router.js');
        router.default.beforeEnter('profile');
        header.initHeader();
        backButton.initBackButton('backButtonContainer');
        footer.initFooter();
        const loadUserInfo = async () => {
            try {
                const response = await api.get('/user/profile');
                if (response.success && response.data) {
                    const user = response.data;
                    
                    // 更新用户名和邮箱
                    document.getElementById('userName').textContent = user.username || '用户';
                    document.getElementById('userEmail').textContent = user.email || '';
                    
                    // 更新头像
                    const userAvatar = document.getElementById('userAvatar');
                    if (user.avatar) {
                        // 如果有头像URL，显示图片
                        userAvatar.innerHTML = `<img src="${user.avatar}" alt="${user.username}" class="w-full h-full rounded-full object-cover">`;
                    } else {
                        // 否则显示首字母
                        const firstChar = (user.username || '用').charAt(0).toUpperCase();
                        userAvatar.textContent = firstChar;
                        userAvatar.className = 'w-24 h-24 bg-indigo-600 rounded-full mx-auto mb-4 flex items-center justify-center text-white text-3xl';
                    }
                    
                    // 更新表单字段
                    document.getElementById('username').value = user.username || '';
                    document.getElementById('email').value = user.email || '';
                    document.getElementById('phone').value = user.phone || '';
                    document.getElementById('real_name').value = user.real_name || '';
                    
                    // 更新角色标签
                    const roleMap = { 
                        'admin': '管理员', 
                        'decision_user': '决策用户', 
                        'normal_user': '普通用户' 
                    };
                    const roleText = roleMap[user.role] || '普通用户';
                    document.getElementById('userRole').textContent = roleText;
                    
                    // 根据角色设置不同的颜色
                    const roleElement = document.getElementById('userRole');
                    roleElement.className = 'inline-block px-4 py-2 rounded-full text-sm font-semibold';
                    if (user.role === 'admin') {
                        roleElement.classList.add('bg-red-100', 'text-red-700');
                    } else if (user.role === 'decision_user') {
                        roleElement.classList.add('bg-blue-100', 'text-blue-700');
                    } else {
                        roleElement.classList.add('bg-indigo-100', 'text-indigo-700');
                    }
                }
            } catch (error) {
                console.error('加载用户信息失败:', error);
                common.showMessage('加载用户信息失败', 'error');
            }
        };
        let currentFavoritesPage = 1;
        let favoritesPageSize = 20;
        let favoritesTotalCount = 0;

        // 加载收藏列表
        const loadFavorites = async (page = 1) => {
            try {
                const response = await api.get('/favorite/list', {
                    page: page,
                    pageSize: favoritesPageSize
                });
                if (response.success && response.data) {
                    const { list, total, page: currentPage } = response.data;
                    favoritesTotalCount = total;
                    currentFavoritesPage = currentPage;
                    
                    renderFavorites(list);
                    renderFavoritesPagination(currentPage, Math.ceil(total / favoritesPageSize));
                } else {
                    document.getElementById('favoritesList').innerHTML = '<div class="text-center text-gray-500 py-8">暂无收藏</div>';
                }
            } catch (error) {
                console.error('加载收藏列表失败:', error);
                document.getElementById('favoritesList').innerHTML = '<div class="text-center text-red-500 py-8">加载失败</div>';
            }
        };

        // 渲染收藏列表
        const renderFavorites = (favorites) => {
            const favoritesList = document.getElementById('favoritesList');
            if (favorites.length === 0) {
                favoritesList.innerHTML = '<div class="text-center text-gray-500 py-8">暂无收藏</div>';
                return;
            }

            favoritesList.innerHTML = favorites.map((item, index) => {
                const title = item.title || '';
                return `
                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                    <div class="flex-1">
                        <div class="font-medium text-gray-800 mb-1">
                            <a href="javascript:void(0)" data-id="${item.id}" data-title="${title.replace(/"/g, '&quot;')}" class="view-favorite-detail-link text-indigo-600 hover:text-indigo-900 hover:underline">${title || '-'}</a>
                        </div>
                        <div class="text-sm text-gray-600">
                            <span class="mr-4">类别：${item.category || '-'}</span>
                            <span class="mr-4">来源：${item.source || '-'}</span>
                            <span>记录数：${item.record_count || 0}</span>
                        </div>
                        <div class="text-xs text-gray-500 mt-1">收藏时间：${formatDate(item.favorite_time)}</div>
                    </div>
                    ${favoriteButton.createIconButton(item.id, true, 'md')}
                </div>
            `;
            }).join('');
            
            // 初始化收藏按钮事件监听（需要确认）
            favoriteButton.initIconButtons((dataId, newStatus) => {
                // 取消收藏后刷新列表
                if (!newStatus) {
                    loadFavorites(currentFavoritesPage);
                }
            }, true); // 第二个参数：需要确认

            // 绑定查看详情链接事件
            document.querySelectorAll('.view-favorite-detail-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const dataId = parseInt(link.getAttribute('data-id'));
                    const title = link.getAttribute('data-title');
                    viewFavoriteDetail(dataId, title);
                });
            });
        };

        // 渲染收藏分页
        const renderFavoritesPagination = (page, totalPages) => {
            // 初始化分页HTML（如果还没有）
            const paginationContainer = document.getElementById('favoritesPagination');
            if (!paginationContainer.innerHTML.trim()) {
                paginationContainer.innerHTML = pagination.createPaginationHTML('favoritesPagination', true);
            }
            
            pagination.renderPagination({
                page: page,
                totalPages: totalPages,
                total: favoritesTotalCount,
                pageSize: favoritesPageSize,
                containerId: 'favoritesPagination',
                onPageChange: (newPage) => {
                    currentFavoritesPage = newPage;
                    loadFavorites(newPage);
                },
                onPageSizeChange: (newPageSize) => {
                    favoritesPageSize = newPageSize;
                    currentFavoritesPage = 1;
                    loadFavorites(1);
                },
                maxButtons: 5,
                showPageSize: true
            });
        };

        // 查看收藏详情
        window.viewFavoriteDetail = (dataId, title) => {
            if (!title) {
                common.showMessage('数据标题缺失，无法打开详情页', 'error');
                return;
            }
            const routerModule = import('../utils/router.js');
            routerModule.then(module => {
                const detailPath = module.default.getPath('dataDetail', { title: title });
                window.open(detailPath, '_blank');
            });
        };


        // 格式化日期
        const formatDate = (dateString) => {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        };

        const loadLogs = async () => {
            try {
                const response = await api.get('/user/logs');
                if (response.success && response.data) {
                    const logs = response.data;
                    document.getElementById('logsList').innerHTML = logs.map(log => `
                        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                            <div>
                                <div class="font-medium text-gray-800">${log.action}</div>
                                <div class="text-sm text-gray-600">${log.details} | 时间：${formatDate(log.createdAt)}</div>
                            </div>
                            <button class="text-indigo-600 hover:text-indigo-800 text-sm">查看详情</button>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('加载记录失败:', error);
            }
        };
        document.getElementById('profileForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const response = await api.put('/user/update', {
                    email: document.getElementById('email').value,
                    phone: document.getElementById('phone').value,
                    real_name: document.getElementById('real_name').value
                });
                if (response.success) {
                    common.showMessage('保存成功', 'success');
                    loadUserInfo(); // 重新加载用户信息以更新显示
                }
            } catch (error) {
                common.showMessage('保存失败: ' + (error.message || '未知错误'), 'error');
            }
        });
        document.getElementById('passwordForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            if (newPassword !== confirmPassword) {
                common.showMessage('两次输入的密码不一致', 'error');
                return;
            }
            try {
                const response = await api.post('/user/password', {
                    currentPassword: document.getElementById('currentPassword').value,
                    newPassword: newPassword
                });
                if (response.success) {
                    common.showMessage('密码修改成功', 'success');
                    document.getElementById('passwordForm').reset();
                }
            } catch (error) {
                common.showMessage('密码修改失败', 'error');
            }
        });
        window.scrollToSection = (id) => {
            document.getElementById(id).scrollIntoView({ behavior: 'smooth' });
        };
        loadUserInfo();
        loadFavorites();
        loadLogs();
    </script>
</body>
</html>

