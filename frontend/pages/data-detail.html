<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®è¯¦æƒ… - æ•°æ™ºæ¹–åŒ—</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js - ä½¿ç”¨å›½å†… CDNï¼Œæ— éœ€ VPN -->
    <script src="https://cdn.bootcdn.net/ajax/libs/Chart.js/4.4.0/chart.umd.min.js" 
            onerror="this.onerror=null;this.src='https://unpkg.com/chart.js@4.4.0/dist/chart.umd.min.js'"></script>
    <!-- ECharts - ä½¿ç”¨å›½å†… CDNï¼Œæ— éœ€ VPN -->
    <script src="https://cdn.bootcdn.net/ajax/libs/echarts/5.4.3/echarts.min.js" 
            onerror="this.onerror=null;this.src='https://unpkg.com/echarts@5.4.3/dist/echarts.min.js'"></script>
    <link rel="stylesheet" href="../public/css/common.css">
    <link rel="stylesheet" href="../public/css/components.css">
    <link rel="stylesheet" href="../public/css/footer.css">
    <link rel="stylesheet" href="../public/css/cards.css">
</head>
<body class="bg-gray-50">
    <!-- å¯¼èˆªæ  -->
    <div id="header"></div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- æ•°æ®åŸºæœ¬ä¿¡æ¯ -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h1 id="dataTitle" class="text-2xl font-bold text-gray-900 mb-2">æ•°æ®æ ‡é¢˜</h1>
                    <p id="dataDescription" class="text-gray-600">æ•°æ®æè¿°</p>
                </div>
                <div class="flex space-x-3" id="favoriteButtonContainer">
                    <!-- æ”¶è—æŒ‰é’®å°†é€šè¿‡ç»„ä»¶åŠ¨æ€ç”Ÿæˆ -->
                    <button id="exportBtn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">å¯¼å‡ºæ•°æ®</button>
                </div>
            </div>

            <!-- æ•°æ®å…ƒä¿¡æ¯ -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 pt-4 border-t border-gray-200">
                <div>
                    <span class="text-sm text-gray-500">ç±»åˆ«ï¼š</span>
                    <span id="dataCategory" class="text-sm font-medium text-gray-900 ml-2">-</span>
                </div>
                <div>
                    <span class="text-sm text-gray-500">æ¥æºï¼š</span>
                    <span id="dataSource" class="text-sm font-medium text-gray-900 ml-2">-</span>
                </div>
                <div>
                    <span class="text-sm text-gray-500">æ•°æ®ç±»å‹ï¼š</span>
                    <span id="dataType" class="text-sm font-medium text-gray-900 ml-2">-</span>
                </div>
                <div>
                    <span class="text-sm text-gray-500">åˆ›å»ºæ—¶é—´ï¼š</span>
                    <span id="dataCreatedAt" class="text-sm font-medium text-gray-900 ml-2">-</span>
                </div>
                <div>
                    <span class="text-sm text-gray-500">è®°å½•æ•°ï¼š</span>
                    <span id="dataRecordCount" class="text-sm font-medium text-gray-900 ml-2">-</span>
                </div>
                <div>
                    <span class="text-sm text-gray-500">çŠ¶æ€ï¼š</span>
                    <span id="dataStatus" class="text-sm font-medium text-gray-900 ml-2">-</span>
                </div>
                <div>
                    <span class="text-sm text-gray-500">ä¸Šä¼ è€…ï¼š</span>
                    <span id="dataUploader" class="text-sm font-medium text-gray-900 ml-2">-</span>
                </div>
                <div>
                    <span class="text-sm text-gray-500">æ›´æ–°æ—¶é—´ï¼š</span>
                    <span id="dataUpdatedAt" class="text-sm font-medium text-gray-900 ml-2">-</span>
                </div>
            </div>
        </div>

        <!-- æ•°æ®å¯è§†åŒ– -->
        <div id="visualizationContainer" class="bg-white rounded-lg shadow-md p-6 mb-6">
            <!-- åŠ¨æ€å†…å®¹ï¼šæ ¹æ®æ•°æ®æ ‡é¢˜æ˜¾ç¤ºä¸åŒçš„å¯è§†åŒ–æ–¹æ¡ˆ -->
        </div>

        <!-- æ•°æ®è®°å½•è¡¨æ ¼ -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-800 mb-0">æ•°æ®è®°å½•</h3>
            </div>

            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">åºå·</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">è®°å½•æ—¥æœŸ</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ•°å€¼</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ–‡æœ¬å€¼</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å¤‡æ³¨</th>
                        </tr>
                    </thead>
                    <tbody id="recordsTableBody" class="bg-white divide-y divide-gray-200">
                        <tr>
                            <td colspan="5" class="px-6 py-4 text-center text-gray-500">åŠ è½½ä¸­...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- è®°å½•åˆ†é¡µ -->
            <div id="recordPagination"></div>
        </div>
    </div>

    <!-- Footer -->
    <div id="footer"></div>

    <script type="module">
        import api from '../utils/api.js';
        import auth from '../utils/auth.js';
        import header from '../components/header.js';
        import footer from '../components/footer.js';
        import common from '../utils/common.js';
        import favoriteButton from '../components/favoriteButton.js';
        import pagination from '../components/pagination.js';
        import mapVisualization from '../components/mapVisualization.js';
        
        // æ£€æŸ¥ç™»å½•çŠ¶æ€ï¼ˆä½¿ç”¨è·¯ç”±å®ˆå«ï¼‰
        const routerModule = await import('../utils/router.js');
        const router = routerModule.default;
        router.beforeEnter('dataDetail');

        // åˆå§‹åŒ–å¯¼èˆªæ 
        header.initHeader();
        
        // åˆå§‹åŒ– Footer
        footer.initFooter();

        // ä» URL å‚æ•°è·å–æ•°æ®æ ‡é¢˜
        const urlParams = router.getParams();
        const dataTitle = urlParams.title || urlParams.dataTitle;
        
        if (!dataTitle) {
            common.showMessage('ç¼ºå°‘æ•°æ®æ ‡é¢˜å‚æ•°ï¼Œè¯·ä»æ•°æ®åˆ—è¡¨é¡µé¢è¿›å…¥', 'error');
            setTimeout(() => {
                router.navigate('query');
            }, 2000);
        }

        let dataId = null;
        let visualizationType = null; // 'monthly' | 'city' | 'unknown'

        let currentRecordPage = 1;
        let recordPageSize = 20;
        let recordTotalCount = 0;
        let currentChart = null;
        let dataRecords = []; // å­˜å‚¨æ•°æ®è®°å½•

        // æ ¼å¼åŒ–æ—¥æœŸ
        const formatDate = (dateString) => {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        };

        // å­˜å‚¨æ•°æ®è¯¦æƒ…å’Œæœˆåº¦æ•°æ®
        let dataDetail = null;
        let monthlyData = [];

        // åŠ è½½æ•°æ®è¯¦æƒ…
        const loadDataDetail = async () => {
            try {
                if (!dataTitle) {
                    return;
                }

                // æ ¹æ®æ ‡é¢˜è·å–æ•°æ®è¯¦æƒ…
                const encodedTitle = encodeURIComponent(dataTitle);
                const response = await api.get(`/data/by-title/${encodedTitle}`);
                if (!response.success || !response.data) {
                    throw new Error('è·å–æ•°æ®è¯¦æƒ…å¤±è´¥ï¼Œè¯·ç¡®ä¿æ•°æ®å·²å¯¼å…¥');
                }

                dataDetail = response.data;
                dataId = dataDetail.id; // ä¿å­˜æ•°æ®IDä¾›åç»­ä½¿ç”¨

                // ç¡®å®šå¯è§†åŒ–ç±»å‹ï¼ˆä»åç«¯è¿”å›çš„ visualizationTypeï¼‰
                // 'monthly' -> å›¾è¡¨å¯è§†åŒ–ï¼ˆæœˆåº¦æ•°æ®ï¼‰
                // 'city' -> åœ°å›¾å¯è§†åŒ–ï¼ˆåŸå¸‚æ•°æ®ï¼‰
                // 'unknown' -> ä¸æ”¯æŒå¯è§†åŒ–
                visualizationType = dataDetail.visualizationType || 'unknown';

                // å¡«å……åŸºæœ¬ä¿¡æ¯
                document.getElementById('dataTitle').textContent = dataDetail.title || 'æ•°æ®æ ‡é¢˜';
                document.getElementById('dataDescription').textContent = dataDetail.description || 'æ•°æ®æè¿°';
                document.getElementById('dataCategory').textContent = dataDetail.category || '-';
                document.getElementById('dataSource').textContent = dataDetail.source || '-';
                document.getElementById('dataType').textContent = dataDetail.data_type || '-';
                document.getElementById('dataCreatedAt').textContent = formatDate(dataDetail.created_at);
                document.getElementById('dataStatus').textContent = dataDetail.status === 'approved' ? 'å·²å®¡æ ¸' : 'å¾…å®¡æ ¸';
                document.getElementById('dataUploader').textContent = dataDetail.uploader_name || '-';
                document.getElementById('dataUpdatedAt').textContent = formatDate(dataDetail.updated_at);

                // è·å–è®°å½•æ€»æ•°
                const recordsResponse = await api.get(`/data/${dataId}/records`, { page: 1, pageSize: 1 });
                if (recordsResponse.success) {
                    recordTotalCount = recordsResponse.data.total || 0;
                    document.getElementById('dataRecordCount').textContent = `${recordTotalCount} æ¡`;
                }

                // åˆå§‹åŒ–æ”¶è—æŒ‰é’®
                const favoriteBtnHtml = favoriteButton.createTextButton(dataId, false, 'favoriteBtn');
                const container = document.getElementById('favoriteButtonContainer');
                if (container) {
                    container.insertAdjacentHTML('afterbegin', favoriteBtnHtml);
                    await favoriteButton.initTextButton('favoriteBtn', dataId);
                }

                // æ ¹æ®å¯è§†åŒ–ç±»å‹åˆå§‹åŒ–ä¸åŒçš„å¯è§†åŒ–æ–¹æ¡ˆ
                if (visualizationType === 'monthly') {
                    await initChartVisualization();
                } else if (visualizationType === 'city') {
                    await initMapVisualization();
                } else {
                    showUnsupportedVisualization();
                }

                // åŠ è½½æ•°æ®è®°å½•
                loadRecords(1);

            } catch (error) {
                console.error('åŠ è½½æ•°æ®è¯¦æƒ…å¤±è´¥:', error);
                common.showMessage('åŠ è½½æ•°æ®è¯¦æƒ…å¤±è´¥: ' + error.message, 'error');
            }
        };

        // åˆå§‹åŒ–å›¾è¡¨å¯è§†åŒ–
        const initChartVisualization = async () => {
            const container = document.getElementById('visualizationContainer');
            container.innerHTML = `
                <h2 class="text-xl font-bold text-gray-800 mb-6">æ•°æ®é›†å¯è§†åŒ–</h2>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2">
                        <div class="bg-gray-50 rounded-lg p-6" style="height: 400px;">
                            <div id="chartContainer" class="w-full h-full" style="position: relative;">
                                <canvas id="dynamicChart" style="max-width: 100%; max-height: 100%;"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="lg:col-span-1">
                        <div class="mb-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-2">å›¾è¡¨ç±»å‹</h3>
                            <select id="chartType" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="line" selected>æŠ˜çº¿å›¾</option>
                                <option value="bar">æŸ±çŠ¶å›¾</option>
                                <option value="pie">é¥¼å›¾</option>
                                <option value="radar">é›·è¾¾å›¾</option>
                            </select>
                        </div>
                        <!-- å›¾è¡¨è¯´æ˜ -->
                        <div class="mt-6 pt-6 border-t border-gray-200">
                            <h3 class="text-lg font-semibold text-gray-800 mb-2">å›¾è¡¨è¯´æ˜</h3>
                            <div id="chartInfo" class="text-sm text-gray-600">
                                <p class="text-gray-500">å›¾è¡¨è¯´æ˜å°†åœ¨æ­¤æ˜¾ç¤ºã€‚</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // åŠ è½½æœˆåº¦ç»Ÿè®¡æ•°æ®ï¼ˆç”¨äºå›¾è¡¨ï¼‰
            try {
                const response = await api.get(`/data/${dataId}/records/months`);
                if (response.success && response.data) {
                    monthlyData = response.data;
                    
                    // æ•°æ®åŠ è½½å®Œæˆåï¼Œè‡ªåŠ¨ç”Ÿæˆé»˜è®¤å›¾è¡¨ï¼ˆæŠ˜çº¿å›¾ï¼‰
                    if (monthlyData.length > 0) {
                        generateChart();
                    }
                }
            } catch (error) {
                console.error('åŠ è½½æœˆåº¦ç»Ÿè®¡å¤±è´¥:', error);
            }

            // ç»‘å®šå›¾è¡¨ç±»å‹ä¸‹æ‹‰æ¡†å˜åŒ–äº‹ä»¶ï¼Œè‡ªåŠ¨ç”Ÿæˆå›¾è¡¨
            const chartTypeSelect = document.getElementById('chartType');
            chartTypeSelect.addEventListener('change', () => {
                if (monthlyData.length > 0) {
                    generateChart();
                }
                updateChartInfo(chartTypeSelect.value);
            });
            
            // åˆå§‹åŒ–å›¾è¡¨è¯´æ˜ï¼ˆæ˜¾ç¤ºé»˜è®¤å›¾è¡¨ç±»å‹ï¼‰
            updateChartInfo('line');
        };
        
        // æ›´æ–°å›¾è¡¨è¯´æ˜
        const updateChartInfo = (chartType) => {
            const chartInfo = document.getElementById('chartInfo');
            if (!chartInfo) return;
            
            const chartDescriptions = {
                'line': 'æŠ˜çº¿å›¾é€šè¿‡è¿æ¥æ•°æ®ç‚¹å½¢æˆæŠ˜çº¿ï¼Œèƒ½å¤Ÿæ¸…æ™°åœ°å±•ç¤ºæ•°æ®éšæ—¶é—´çš„å˜åŒ–è¶‹åŠ¿ã€‚é€‚åˆå±•ç¤ºè¿ç»­æ•°æ®çš„è¶‹åŠ¿å˜åŒ–ï¼Œå¯ä»¥ç›´è§‚åœ°çœ‹å‡ºæ•°æ®çš„ä¸Šå‡ã€ä¸‹é™æˆ–æ³¢åŠ¨è§„å¾‹ã€‚',
                'bar': 'æŸ±çŠ¶å›¾é€šè¿‡ä¸åŒé«˜åº¦çš„æŸ±å½¢æ¥æ¯”è¾ƒä¸åŒç±»åˆ«çš„æ•°æ®å€¼ã€‚é€‚åˆå±•ç¤ºåˆ†ç±»æ•°æ®çš„å¯¹æ¯”ï¼Œèƒ½å¤Ÿç›´è§‚åœ°çœ‹å‡ºå„ä¸ªæœˆä»½ä¹‹é—´çš„æ•°å€¼å·®å¼‚ã€‚',
                'pie': 'é¥¼å›¾é€šè¿‡æ‰‡å½¢é¢ç§¯çš„å¤§å°æ¥è¡¨ç¤ºå„éƒ¨åˆ†åœ¨æ€»ä½“ä¸­çš„å æ¯”ã€‚é€‚åˆå±•ç¤ºæ•°æ®çš„æ„æˆæ¯”ä¾‹ï¼Œèƒ½å¤Ÿç›´è§‚åœ°çœ‹å‡ºå„ä¸ªæœˆä»½æ•°æ®åœ¨å…¨å¹´æ€»é‡ä¸­çš„å æ¯”å…³ç³»ã€‚',
                'radar': 'é›·è¾¾å›¾é€šè¿‡å¤šä¸ªç»´åº¦å±•ç¤ºæ•°æ®çš„ç»¼åˆç‰¹å¾ï¼Œèƒ½å¤ŸåŒæ—¶æ¯”è¾ƒå¤šä¸ªæŒ‡æ ‡ã€‚é€‚åˆå±•ç¤ºå¤šç»´æ•°æ®çš„ç»¼åˆè¡¨ç°ï¼Œå¯ä»¥ç›´è§‚åœ°çœ‹å‡ºæ•°æ®åœ¨ä¸åŒç»´åº¦ä¸Šçš„åˆ†å¸ƒæƒ…å†µã€‚'
            };
            
            const description = chartDescriptions[chartType] || chartDescriptions['line'];
            
            chartInfo.innerHTML = `<p>${description}</p>`;
        };

        // åˆå§‹åŒ–åœ°å›¾å¯è§†åŒ–
        const initMapVisualization = async () => {
            const container = document.getElementById('visualizationContainer');
            // ç›´æ¥åˆ›å»ºåœ°å›¾å†…å®¹ï¼Œä¸åŒ…å«å¤–å±‚å¡ç‰‡ï¼ˆå› ä¸º visualizationContainer å·²ç»æ˜¯å¡ç‰‡äº†ï¼‰
            container.innerHTML = `
                <h2 class="text-xl font-bold text-gray-800 mb-6">æ•°æ®é›†å¯è§†åŒ–</h2>
                <div id="dataDetailMapMap" style="height: 500px; position: relative;"></div>
                <div class="mt-4 flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center">
                            <div class="w-4 h-4 bg-blue-600 rounded mr-2"></div>
                            <span class="text-sm text-gray-600">é«˜å€¼åŒºåŸŸ</span>
                        </div>
                        <div class="flex items-center">
                            <div class="w-4 h-4 bg-green-500 rounded mr-2"></div>
                            <span class="text-sm text-gray-600">ä¸­å€¼åŒºåŸŸ</span>
                        </div>
                        <div class="flex items-center">
                            <div class="w-4 h-4 bg-yellow-500 rounded mr-2"></div>
                            <span class="text-sm text-gray-600">ä½å€¼åŒºåŸŸ</span>
                        </div>
                    </div>
                    <div class="text-sm text-gray-600">
                        <span id="dataDetailMapStats">åŠ è½½ä¸­...</span>
                    </div>
                </div>
            `;

            try {
                const response = await api.get('/visualization/map', {
                    dataTitle: dataDetail.title
                });

                if (response.success && response.data) {
                    if (response.data.length === 0) {
                        throw new Error('åœ°å›¾æ•°æ®ä¸ºç©ºï¼Œè¯·å…ˆå¯¼å…¥æ•°æ®');
                    }

                    // ä»ç¬¬ä¸€æ¡è®°å½•çš„ metadata ä¸­è·å–å•ä½ï¼Œå¦‚æœæ²¡æœ‰åˆ™æ ¹æ®æ ‡é¢˜æ™ºèƒ½è¯†åˆ«
                    let unit = '';
                    if (response.data && response.data.length > 0) {
                        // å°è¯•ä»æ•°æ®ä¸­è·å–å•ä½ï¼ˆå¦‚æœåç«¯è¿”å›äº† unit å­—æ®µï¼‰
                        unit = response.data[0].unit || '';
                    }
                    
                    // å¦‚æœè¿˜æ˜¯æ²¡æœ‰ï¼Œä»ç¬¬ä¸€æ¡è®°å½•çš„ metadata ä¸­è·å–ï¼ˆéœ€è¦åç«¯è¿”å›å®Œæ•´æ•°æ®ï¼‰
                    // å¦åˆ™æ ¹æ®æ ‡é¢˜æ™ºèƒ½è¯†åˆ«ï¼ˆå‘åå…¼å®¹ï¼‰
                    if (!unit) {
                        if (dataDetail.title.includes('é™æ°´é‡')) {
                            unit = 'mm';
                        } else if (dataDetail.title.includes('ä¼ä¸šæ³¨å†Œ') || dataDetail.title.includes('æ³¨å†Œæ•°é‡')) {
                            unit = 'å®¶';
                        } else if (dataDetail.title.includes('ç ”å‘ç»è´¹') || dataDetail.title.includes('ç»è´¹æŠ•å…¥')) {
                            unit = 'äº¿å…ƒ';
                        } else if (dataDetail.title.includes('æ°”æ¸©') || dataDetail.title.includes('å¹³å‡æ°”æ¸©')) {
                            unit = 'â„ƒ';
                        } else if (dataDetail.title.includes('å°±ä¸šç‡') || dataDetail.title.includes('åˆæ ¼ç‡')) {
                            unit = '%';
                        }
                    }
                    
                    await mapVisualization.initMapVisualization({
                        containerId: 'dataDetailMap',
                        mapContainerId: 'dataDetailMapMap', // æŒ‡å®šåœ°å›¾å®¹å™¨ID
                        statsContainerId: 'dataDetailMapStats', // æŒ‡å®šç»Ÿè®¡ä¿¡æ¯å®¹å™¨ID
                        data: response.data,
                        mapName: 'hubei',
                        unit: unit
                    });
                } else {
                    throw new Error(response.message || 'è·å–åœ°å›¾æ•°æ®å¤±è´¥');
                }
            } catch (error) {
                console.error('åˆå§‹åŒ–åœ°å›¾å¯è§†åŒ–å¤±è´¥:', error);
                const mapContainer = document.getElementById('dataDetailMap');
                if (mapContainer) {
                    mapContainer.innerHTML = `
                        <div class="flex items-center justify-center h-full text-gray-500">
                            <div class="text-center">
                                <div class="text-4xl mb-4">âš ï¸</div>
                                <p class="font-semibold mb-2">åŠ è½½åœ°å›¾æ•°æ®å¤±è´¥</p>
                                <p class="text-sm">${error.message || 'æœªçŸ¥é”™è¯¯'}</p>
                            </div>
                        </div>
                    `;
                }
            }
        };

        // æ˜¾ç¤ºä¸æ”¯æŒçš„å¯è§†åŒ–æç¤º
        const showUnsupportedVisualization = () => {
            const container = document.getElementById('visualizationContainer');
            container.innerHTML = `
                <h2 class="text-xl font-bold text-gray-800 mb-6">æ•°æ®é›†å¯è§†åŒ–</h2>
                <div class="bg-gray-50 rounded-lg p-12 text-center">
                    <div class="text-6xl mb-4">ğŸ“‹</div>
                    <p class="text-lg font-semibold text-gray-700 mb-2">è¯¥æ•°æ®æš‚ä¸æ”¯æŒå¯è§†åŒ–å±•ç¤º</p>
                    <p class="text-sm text-gray-500 mb-4">å½“å‰æ”¯æŒçš„æ•°æ®ç±»å‹ï¼š</p>
                    <ul class="text-sm text-gray-600 space-y-1 mb-6">
                        <li>â€¢ æœˆåº¦æ•°æ®ï¼ˆmetadata åŒ…å« month å­—æ®µï¼‰â†’ å›¾è¡¨å¯è§†åŒ–</li>
                        <li>â€¢ åŸå¸‚æ•°æ®ï¼ˆmetadata åŒ…å« city å­—æ®µï¼‰â†’ åœ°å›¾å¯è§†åŒ–</li>
                    </ul>
                    <p class="text-xs text-gray-400">è¯·ç¡®ä¿æ•°æ®è®°å½•çš„ metadata å­—æ®µåŒ…å« month æˆ– city ä¿¡æ¯</p>
                </div>
            `;
        };


        // ç”Ÿæˆå›¾è¡¨
        const generateChart = () => {
            const chartType = document.getElementById('chartType')?.value || 'line';

            // æ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®
            if (monthlyData.length === 0) {
                const chartContainer = document.getElementById('chartContainer');
                if (chartContainer) {
                    chartContainer.innerHTML = `
                        <div class="flex items-center justify-center h-full text-gray-400">
                            <div class="text-center">
                                <div class="text-4xl mb-4">ğŸ“Š</div>
                                <p class="text-lg">æš‚æ— æ•°æ®</p>
                            </div>
                        </div>
                    `;
                }
                return;
            }

            // ç”Ÿæˆå›¾è¡¨æ•°æ®
            const chartData = generateChartData(chartType);

            // é”€æ¯æ—§å›¾è¡¨
            if (currentChart) {
                currentChart.destroy();
            }

            // ç¡®ä¿ç”»å¸ƒå­˜åœ¨
            let canvas = document.getElementById('dynamicChart');
            if (!canvas) {
                const chartContainer = document.getElementById('chartContainer');
                if (chartContainer) {
                    chartContainer.innerHTML = '<canvas id="dynamicChart" style="max-width: 100%; max-height: 100%;"></canvas>';
                    canvas = document.getElementById('dynamicChart');
                } else {
                    return;
                }
            }

            // åˆ›å»ºæ–°å›¾è¡¨
            const ctx = canvas.getContext('2d');
            currentChart = new Chart(ctx, chartData);
        };

        // ç”Ÿæˆå›¾è¡¨æ•°æ®
        const generateChartData = (chartType) => {
            // ä½¿ç”¨æœˆåº¦æ•°æ®ï¼ˆé€‚é…ä¼ä¸šæ³¨å†Œæ•°é‡ç»Ÿè®¡ï¼‰
            const labels = monthlyData.map(item => item.monthName || `${item.month}æœˆ`);
            // æ ¹æ®æ•°æ®æ ‡é¢˜ä½¿ç”¨ä¸åŒçš„å­—æ®µ
            const dataValues = monthlyData.map(item => {
                // ä¼ä¸šæ³¨å†Œæ•°é‡ç»Ÿè®¡ä½¿ç”¨ count å­—æ®µï¼Œç ”å‘ç»è´¹ä½¿ç”¨ funding å­—æ®µ
                return item.count || item.funding || item.value || 0;
            });

            let datasets;

            // æ ¹æ®æ•°æ®æ ‡é¢˜ç¡®å®šæ ‡ç­¾å’Œå•ä½ï¼ˆä¼˜å…ˆä» metadata è¯»å–å•ä½ï¼‰
            let dataLabel = 'æ•°æ®å€¼';
            let yAxisLabel = 'æ•°æ®å€¼';
            
            // ä»ç¬¬ä¸€æ¡æœˆåº¦æ•°æ®ä¸­è·å–å•ä½
            let unit = '';
            if (monthlyData && monthlyData.length > 0) {
                unit = monthlyData[0].unit || '';
            }
            
            // å¦‚æœæ²¡æœ‰å•ä½ï¼Œæ ¹æ®æ ‡é¢˜å…³é”®è¯è‡ªåŠ¨è¯†åˆ«ï¼ˆå‘åå…¼å®¹ï¼‰
            if (!unit) {
                if (dataDetail.title.includes('ä¼ä¸šæ³¨å†Œ') || dataDetail.title.includes('æ³¨å†Œæ•°é‡')) {
                    unit = 'å®¶';
                } else if (dataDetail.title.includes('ç ”å‘ç»è´¹') || dataDetail.title.includes('ç»è´¹æŠ•å…¥')) {
                    unit = 'äº¿å…ƒ';
                } else if (dataDetail.title.includes('é™æ°´é‡')) {
                    unit = 'mm';
                } else if (dataDetail.title.includes('æ°”æ¸©') || dataDetail.title.includes('å¹³å‡æ°”æ¸©')) {
                    unit = 'â„ƒ';
                } else if (dataDetail.title.includes('å°±ä¸šç‡') || dataDetail.title.includes('åˆæ ¼ç‡')) {
                    unit = '%';
                }
            }
            
            // æ„å»ºæ ‡ç­¾
            if (unit) {
                dataLabel = `æ•°æ®å€¼ï¼ˆ${unit}ï¼‰`;
                yAxisLabel = `æ•°æ®å€¼ï¼ˆ${unit}ï¼‰`;
            }

            switch (chartType) {
                case 'line':
                    datasets = [{
                        label: dataLabel,
                        data: dataValues,
                        borderColor: 'rgb(99, 102, 241)',
                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                        tension: 0.4,
                        fill: false
                    }];
                    break;

                case 'bar':
                    datasets = [{
                        label: dataLabel,
                        data: dataValues,
                        backgroundColor: 'rgba(99, 102, 241, 0.8)'
                    }];
                    break;

                case 'pie':
                    // ä½¿ç”¨ HSL é¢œè‰²ç©ºé—´ï¼ŒæŒ‰é¡ºæ—¶é’ˆæ–¹å‘æ¸å˜
                    // ä»è“è‰² (240åº¦) å¼€å§‹ï¼Œé¡ºæ—¶é’ˆæ¸å˜åˆ°ç´«è‰² (300åº¦)ï¼Œè¦†ç›–60åº¦è‰²ç›¸èŒƒå›´
                    const generatePieColors = (count) => {
                        const colors = [];
                        const startHue = 240;  // è“è‰²èµ·å§‹è‰²ç›¸
                        const endHue = 300;   // ç´«è‰²ç»“æŸè‰²ç›¸ï¼ˆè¦†ç›–60åº¦èŒƒå›´ï¼‰
                        
                        for (let i = 0; i < count; i++) {
                            // è®¡ç®—å½“å‰æ‰‡åŒºçš„è‰²ç›¸ï¼ˆæŒ‰æ¯”ä¾‹åˆ†é…ï¼Œé¡ºæ—¶é’ˆæ¸å˜ï¼‰
                            const progress = i / count;
                            const hue = startHue + (endHue - startHue) * progress;
                            
                            // é¥±å’Œåº¦å’Œäº®åº¦ä¹ŸæŒ‰è¿›åº¦å˜åŒ–ï¼Œå½¢æˆæ›´æ˜æ˜¾çš„æ¸å˜
                            // é¥±å’Œåº¦ï¼šä» 70% åˆ° 85%ï¼Œä¸­é—´æ‰‡åŒºæ›´é¥±å’Œ
                            const saturation = 70 + (15 * Math.sin(progress * Math.PI));
                            // äº®åº¦ï¼šä» 50% åˆ° 65%ï¼Œå½¢æˆæ˜æš—å˜åŒ–
                            const lightness = 50 + (15 * (1 - Math.abs(progress - 0.5) * 2));
                            
                            // è½¬æ¢ä¸º RGB
                            const hslToRgb = (h, s, l) => {
                                h = h % 360;
                                h /= 360;
                                s /= 100;
                                l /= 100;
                                const c = (1 - Math.abs(2 * l - 1)) * s;
                                const x = c * (1 - Math.abs((h * 6) % 2 - 1));
                                const m = l - c / 2;
                                let r, g, b;
                                if (h < 1/6) {
                                    r = c; g = x; b = 0;
                                } else if (h < 2/6) {
                                    r = x; g = c; b = 0;
                                } else if (h < 3/6) {
                                    r = 0; g = c; b = x;
                                } else if (h < 4/6) {
                                    r = 0; g = x; b = c;
                                } else if (h < 5/6) {
                                    r = x; g = 0; b = c;
                                } else {
                                    r = c; g = 0; b = x;
                                }
                                return [
                                    Math.round((r + m) * 255),
                                    Math.round((g + m) * 255),
                                    Math.round((b + m) * 255)
                                ];
                            };
                            
                            const [r, g, b] = hslToRgb(hue, saturation, lightness);
                            colors.push(`rgba(${r}, ${g}, ${b}, 0.95)`);
                        }
                        return colors;
                    };
                    
                    const pieColors = generatePieColors(labels.length);
                    datasets = [{
                        label: dataLabel,
                        data: dataValues,
                        backgroundColor: pieColors,
                        borderColor: 'rgba(255, 255, 255, 1)',
                        borderWidth: 2
                    }];
                    break;

                case 'radar':
                    datasets = [{
                        label: dataLabel,
                        data: dataValues,
                        borderColor: 'rgb(99, 102, 241)',
                        backgroundColor: 'rgba(99, 102, 241, 0.2)',
                        pointBackgroundColor: 'rgb(99, 102, 241)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgb(99, 102, 241)'
                    }];
                    break;

                default:
                    labels = [];
                    datasets = [];
            }

            // é€šç”¨é…ç½®
            const commonOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        enabled: true
                    }
                }
            };

            // æ ¹æ®å›¾è¡¨ç±»å‹æ·»åŠ ç‰¹å®šé…ç½®
            if (chartType === 'bar' || chartType === 'line') {
                commonOptions.scales = {
                    x: {
                        display: true,
                        title: {
                            display: true,
                            text: 'æœˆä»½'
                        }
                    },
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: yAxisLabel
                        }
                    }
                };
            }

            if (chartType === 'radar') {
                const maxValue = dataValues.length > 0 ? Math.max(...dataValues) * 1.2 : 100;
                commonOptions.scales = {
                    r: {
                        beginAtZero: true,
                        max: maxValue
                    }
                };
            }

            return {
                type: chartType,
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: commonOptions
            };
        };

        // åŠ è½½æ•°æ®è®°å½•ï¼ˆä»APIè·å–ï¼‰
        const loadRecords = async (page = 1) => {
            try {
                const response = await api.get(`/data/${dataId}/records`, {
                    page: page,
                    pageSize: recordPageSize
                });

                if (response.success && response.data) {
                    const { list, total } = response.data;
                    recordTotalCount = total;
                    currentRecordPage = page;
                    
                    renderRecordsTable(list);
                    renderRecordPagination(page, Math.ceil(total / recordPageSize));
                } else {
                    throw new Error('è·å–æ•°æ®è®°å½•å¤±è´¥');
                }

            } catch (error) {
                console.error('åŠ è½½æ•°æ®è®°å½•å¤±è´¥:', error);
                common.showMessage('åŠ è½½æ•°æ®è®°å½•å¤±è´¥: ' + error.message, 'error');
            }
        };

        // æ¸²æŸ“è®°å½•è¡¨æ ¼
        const renderRecordsTable = (records) => {
            const tbody = document.getElementById('recordsTableBody');
            if (records.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">æš‚æ— æ•°æ®</td></tr>';
                return;
            }

            tbody.innerHTML = records.map((record, index) => {
                // æ–‡æœ¬å€¼åˆ—ï¼šä¼˜å…ˆä½¿ç”¨ metadata.monthNameï¼ˆæœˆåº¦æ•°æ®ï¼‰æˆ– metadata.cityï¼ˆåŸå¸‚æ•°æ®ï¼‰
                let textValue = '-';
                if (record.metadata) {
                    if (record.metadata.monthName) {
                        textValue = record.metadata.monthName;
                    } else if (record.metadata.city) {
                        textValue = record.metadata.city;
                    }
                }
                if (textValue === '-' && record.text_value) {
                    textValue = record.text_value;
                }
                
                // æ ¹æ®æ•°æ®ç±»å‹æ ¼å¼åŒ–æ•°å€¼æ˜¾ç¤ºï¼ˆä¼˜å…ˆä» metadata.unit è¯»å–å•ä½ï¼‰
                let valueDisplay = '-';
                if (record.value !== null && record.value !== undefined) {
                    // ä¼˜å…ˆä½¿ç”¨ metadata ä¸­çš„å•ä½
                    const unit = record.metadata?.unit || '';
                    
                    if (unit) {
                        // æ ¹æ®å•ä½ç±»å‹å†³å®šæ˜¾ç¤ºæ ¼å¼
                        if (unit === 'å®¶' || unit === 'ä»¶' || unit === 'æ‰€' || unit === 'ä¸ª' || unit === 'äºº' || unit === 'å¤©' || unit === 'å…¬é‡Œ' || unit === 'ä¸‡äººæ¬¡') {
                            valueDisplay = `${parseInt(record.value)} ${unit}`;
                        } else if (unit === '%' || unit === 'â„ƒ') {
                            valueDisplay = `${parseFloat(record.value).toFixed(1)} ${unit}`;
                        } else if (unit === 'mm' || unit === 'äº¿å…ƒ' || unit === 'å…ƒ') {
                            // mm ä¿ç•™1ä½å°æ•°ï¼Œäº¿å…ƒå’Œå…ƒä¿ç•™2ä½å°æ•°
                            const decimals = unit === 'mm' ? 1 : 2;
                            valueDisplay = `${parseFloat(record.value).toFixed(decimals)} ${unit}`;
                        } else {
                            valueDisplay = `${parseFloat(record.value).toFixed(2)} ${unit}`;
                        }
                    } else {
                        // å¦‚æœæ²¡æœ‰å•ä½ï¼Œæ ¹æ®æ ‡é¢˜å…³é”®è¯æ™ºèƒ½è¯†åˆ«ï¼ˆå‘åå…¼å®¹ï¼‰
                        if (dataDetail.title.includes('ä¼ä¸šæ³¨å†Œ') || dataDetail.title.includes('æ³¨å†Œæ•°é‡')) {
                            valueDisplay = `${parseInt(record.value)} å®¶`;
                        } else if (dataDetail.title.includes('é™æ°´é‡')) {
                            valueDisplay = `${parseFloat(record.value).toFixed(1)} mm`;
                        } else if (dataDetail.title.includes('ç ”å‘ç»è´¹') || dataDetail.title.includes('ç»è´¹æŠ•å…¥')) {
                            valueDisplay = `${parseFloat(record.value).toFixed(2)} äº¿å…ƒ`;
                        } else {
                            valueDisplay = parseFloat(record.value).toFixed(2);
                        }
                    }
                }
                
                // å¤‡æ³¨åˆ—ï¼šä¼˜å…ˆä½¿ç”¨ metadata.descriptionï¼Œå¦åˆ™æ ¹æ®æ•°æ®ç±»å‹ç”Ÿæˆ
                let remark = '-';
                if (record.metadata?.description) {
                    remark = record.metadata.description;
                } else if (record.metadata?.month) {
                    remark = `${record.metadata.month}æœˆæ•°æ®`;
                } else if (record.metadata?.city) {
                    remark = `${record.metadata.city}æ•°æ®`;
                }
                
                return `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${(currentRecordPage - 1) * recordPageSize + index + 1}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${record.record_date}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${valueDisplay}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${textValue}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${remark}</td>
                </tr>
            `;
            }).join('');
        };

        // æ¸²æŸ“è®°å½•åˆ†é¡µ
        const renderRecordPagination = (page, totalPages) => {
            // åˆå§‹åŒ–åˆ†é¡µHTMLï¼ˆå¦‚æœè¿˜æ²¡æœ‰ï¼‰
            const paginationContainer = document.getElementById('recordPagination');
            if (!paginationContainer.innerHTML.trim()) {
                paginationContainer.innerHTML = pagination.createPaginationHTML('recordPagination', true);
            }
            
            pagination.renderPagination({
                page: page,
                totalPages: totalPages,
                total: recordTotalCount,
                pageSize: recordPageSize,
                containerId: 'recordPagination',
                onPageChange: (newPage) => {
                    currentRecordPage = newPage;
                    loadRecords(newPage);
                },
                onPageSizeChange: (newPageSize) => {
                    recordPageSize = newPageSize;
                    currentRecordPage = 1;
                    loadRecords(1);
                },
                maxButtons: 5,
                showPageSize: true
            });
        };

        // å¯¼å‡ºæ•°æ®ï¼ˆä½¿ç”¨é€šç”¨å¯¼å‡ºå‡½æ•°ï¼‰
        document.getElementById('exportBtn').addEventListener('click', async () => {
            if (!dataId) {
                common.showMessage('æ•°æ®æœªåŠ è½½å®Œæˆï¼Œè¯·ç¨å€™', 'error');
                return;
            }

            try {
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                const exportBtn = document.getElementById('exportBtn');
                const originalText = exportBtn.textContent;
                exportBtn.disabled = true;
                exportBtn.textContent = 'å¯¼å‡ºä¸­...';

                await common.exportDataFromAPI(
                    dataId,
                    `${dataDetail.title || 'æ•°æ®å¯¼å‡º'}_${new Date().toISOString().split('T')[0]}.csv`,
                    () => {
                        common.showMessage('å¯¼å‡ºæˆåŠŸ', 'success');
                        exportBtn.disabled = false;
                        exportBtn.textContent = originalText;
                    },
                    (error) => {
                        common.showMessage('å¯¼å‡ºå¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'), 'error');
                        exportBtn.disabled = false;
                        exportBtn.textContent = originalText;
                    }
                );
            } catch (error) {
                // é”™è¯¯å·²åœ¨å›è°ƒä¸­å¤„ç†
                const exportBtn = document.getElementById('exportBtn');
                exportBtn.disabled = false;
                exportBtn.textContent = 'å¯¼å‡ºæ•°æ®';
            }
        });


        // é¡µé¢åŠ è½½æ—¶è·å–æ•°æ®
        if (dataTitle) {
            loadDataDetail();
        }
    </script>
</body>
</html>

