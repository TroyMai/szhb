<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数据查询 - 数智湖北</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="../public/css/common.css">
    <link rel="stylesheet" href="../public/css/components.css">
    <link rel="stylesheet" href="../public/css/footer.css">
</head>
<body class="bg-gray-50">
    <!-- 导航栏 -->
    <div id="header"></div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- 返回首页按钮 -->
        <div id="backButtonContainer"></div>
        <!-- 查询条件 -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-bold text-gray-800 mb-6">查询条件</h2>
            <form id="queryForm">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">数据类别</label>
                        <select id="category" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                            <option value="">全部类别</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">时间范围</label>
                        <div class="flex space-x-2">
                            <input type="date" id="startDate" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                            <span class="self-center text-gray-500">至</span>
                            <input type="date" id="endDate" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">数据来源</label>
                        <select id="source" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                            <option value="">全部来源</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">关键词搜索</label>
                        <input type="text" id="keyword" placeholder="输入关键词进行模糊查询" 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">排序方式</label>
                        <select id="sort" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                            <option value="time_desc">按时间降序</option>
                            <option value="time_asc">按时间升序</option>
                            <option value="value_desc">按记录数降序</option>
                            <option value="value_asc">按记录数升序</option>
                        </select>
                    </div>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="resetBtn" class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">重置</button>
                    <button type="submit" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">查询</button>
                </div>
            </form>
        </div>

        <!-- 查询结果 -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">查询结果</h2>
            </div>

            <!-- 数据表格 -->
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">序号</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">数据名称</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">类别</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">来源</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">记录数</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">创建时间</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                        </tr>
                    </thead>
                    <tbody id="dataTableBody" class="bg-white divide-y divide-gray-200">
                        <tr>
                            <td colspan="7" class="px-6 py-4 text-center text-gray-500">暂无数据，请点击查询</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- 分页 -->
            <div id="pagination"></div>
        </div>
    </div>

    <!-- Footer -->
    <div id="footer"></div>

    <script type="module">
        import api from '../utils/api.js';
        import auth from '../utils/auth.js';
        import header from '../components/header.js';
        import common from '../utils/common.js';
        import backButton from '../components/backButton.js';
        import footer from '../components/footer.js';
        import favoriteButton from '../components/favoriteButton.js';
        import pagination from '../components/pagination.js';

        // 检查登录状态（使用路由守卫）
        const routerModule = await import('../utils/router.js');
        const router = routerModule.default;
        router.beforeEnter('query');

        // 初始化导航栏
        header.initHeader();
        
        // 初始化返回按钮
        backButton.initBackButton('backButtonContainer');
        
        // 初始化 Footer
        footer.initFooter();

        let currentPage = 1;
        let pageSize = 20;
        let totalCount = 0;

        // 加载查询结果
        const loadData = async (page = 1) => {
            const formData = {
                category: document.getElementById('category').value,
                startDate: document.getElementById('startDate').value,
                endDate: document.getElementById('endDate').value,
                source: document.getElementById('source').value,
                keyword: document.getElementById('keyword').value,
                sort: document.getElementById('sort').value,
                page: page,
                pageSize: pageSize
            };

            try {
                const response = await api.post('/data/query', formData);
                if (response.success && response.data) {
                    totalCount = response.data.total || 0;
                    await renderTable(response.data.list || []);
                    renderPagination(page, Math.ceil(totalCount / pageSize));
                } else {
                    await renderTable([]);
                }
            } catch (error) {
                console.error('查询失败:', error);
                common.showMessage('查询失败: ' + error.message, 'error');
            }
        };

        // 格式化日期
        const formatDate = (dateString) => {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        };

        // 存储收藏状态
        let favoriteStatusMap = {};

        // 渲染表格
        const renderTable = async (data) => {
            const tbody = document.getElementById('dataTableBody');
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">暂无数据</td></tr>';
                return;
            }

            // 检查收藏状态
            const dataIds = data.map(item => item.id);
            favoriteStatusMap = await favoriteButton.checkFavoritesBatch(dataIds);

            tbody.innerHTML = data.map((item, index) => {
                const isFavorite = favoriteStatusMap[item.id] || false;
                const title = item.title || '';
                const recordCount = item.record_count || 0;
                return `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${(currentPage - 1) * pageSize + index + 1}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <a href="javascript:void(0)" data-id="${item.id}" data-title="${title.replace(/"/g, '&quot;')}" class="view-detail-link text-indigo-600 hover:text-indigo-900 hover:underline cursor-pointer">${title || '-'}</a>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.category || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.source || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${recordCount} 条</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(item.created_at)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        ${favoriteButton.createIconButton(item.id, isFavorite, 'md')}
                    </td>
                </tr>
            `;
            }).join('');
            
            // 初始化收藏按钮事件监听
            favoriteButton.initIconButtons((dataId, newStatus) => {
                // 更新本地状态映射
                favoriteStatusMap[dataId] = newStatus;
            });

            // 绑定查看详情链接事件
            document.querySelectorAll('.view-detail-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const id = parseInt(link.getAttribute('data-id'));
                    const title = link.getAttribute('data-title');
                    viewDetail(id, title);
                });
            });
        };

        // 渲染分页
        const renderPagination = (page, totalPages) => {
            // 初始化分页HTML（如果还没有）
            const paginationContainer = document.getElementById('pagination');
            if (!paginationContainer.innerHTML.trim()) {
                paginationContainer.innerHTML = pagination.createPaginationHTML('pagination', true);
            }
            
            pagination.renderPagination({
                page: page,
                totalPages: totalPages,
                total: totalCount,
                pageSize: pageSize,
                containerId: 'pagination',
                onPageChange: (newPage) => {
                    currentPage = newPage;
                    loadData(newPage);
                },
                onPageSizeChange: (newPageSize) => {
                    pageSize = newPageSize;
                    currentPage = 1;
                    loadData(1);
                },
                maxButtons: 5,
                showPageSize: true
            });
        };

        // 查看详情（在新标签页打开）
        window.viewDetail = (id, title) => {
            if (!title) {
                common.showMessage('数据标题缺失，无法打开详情页', 'error');
                return;
            }
            const detailPath = router.getPath('dataDetail', { title: title });
            window.open(detailPath, '_blank');
        };

        // 表单提交
        document.getElementById('queryForm').addEventListener('submit', (e) => {
            e.preventDefault();
            currentPage = 1;
            loadData(1);
        });

        // 重置按钮
        document.getElementById('resetBtn').addEventListener('click', () => {
            document.getElementById('queryForm').reset();
            currentPage = 1;
            loadData(1);
        });


        // 加载筛选选项
        const loadFilterOptions = async () => {
            try {
                const response = await api.get('/data/filter-options');
                if (response.success && response.data) {
                    const options = response.data;
                    
                    // 填充类别选项
                    const categorySelect = document.getElementById('category');
                    options.categories.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category;
                        option.textContent = category;
                        categorySelect.appendChild(option);
                    });
                    
                    // 填充数据来源选项
                    const sourceSelect = document.getElementById('source');
                    options.sources.forEach(source => {
                        const option = document.createElement('option');
                        option.value = source;
                        option.textContent = source;
                        sourceSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('加载筛选选项失败:', error);
            }
        };

        // 检查URL参数（搜索关键词、类别、日期范围、数据来源）
        const urlParams = new URLSearchParams(window.location.search);
        const keyword = urlParams.get('keyword');
        const category = urlParams.get('category');
        const startDate = urlParams.get('startDate');
        const endDate = urlParams.get('endDate');
        const source = urlParams.get('source');
        
        // 先加载筛选选项，然后设置URL参数
        loadFilterOptions().then(() => {
            if (keyword) {
                document.getElementById('keyword').value = keyword;
            }
            if (category) {
                document.getElementById('category').value = decodeURIComponent(category);
            }
            if (startDate) {
                document.getElementById('startDate').value = startDate;
            }
            if (endDate) {
                document.getElementById('endDate').value = endDate;
            }
            if (source) {
                document.getElementById('source').value = decodeURIComponent(source);
            }
            // 如果有URL参数，自动执行查询
            if (keyword || category || startDate || endDate || source) {
                loadData(1);
            }
        });
    </script>
</body>
</html>

