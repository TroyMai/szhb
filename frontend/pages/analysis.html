<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å†³ç­–æ”¯æŒ - æ•°æ™ºæ¹–åŒ—</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="../public/css/common.css">
    <link rel="stylesheet" href="../public/css/components.css">
    <link rel="stylesheet" href="../public/css/footer.css">
</head>
<body class="bg-gray-50">
    <div id="header"></div>
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- è¿”å›é¦–é¡µæŒ‰é’® -->
        <div id="backButtonContainer"></div>
        
        <!-- åˆ†æè®¾ç½® -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-bold text-gray-800 mb-6">å†³ç­–åˆ†æè®¾ç½®</h2>
            
            <!-- æ•°æ®æºé€‰æ‹©éƒ¨åˆ† -->
            <div id="dataSourceSection" class="mb-6 pb-6 border-b border-gray-200">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">é€‰æ‹©æ•°æ®æ–‡ä»¶</label>
                    <select id="dataFileSelect" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" required>
                        <option value="" disabled selected>è¯·é€‰æ‹©æ•°æ®æ–‡ä»¶</option>
                    </select>
                </div>
                <div id="dataFileInfo" class="hidden p-3 bg-gray-50 rounded-lg text-sm">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div>
                            <span class="text-gray-600">æ•°æ®æ€»é‡ï¼š</span>
                            <span id="dataTotal" class="font-semibold">-</span>
                        </div>
                        <div>
                            <span class="text-gray-600">åœ°åŒºæ•°é‡ï¼š</span>
                            <span id="dataAreas" class="font-semibold">-</span>
                        </div>
                        <div>
                            <span class="text-gray-600">æŒ‡æ ‡æ•°é‡ï¼š</span>
                            <span id="dataIndicators" class="font-semibold">-</span>
                        </div>
                        <div>
                            <span class="text-gray-600">æ—¶é—´èŒƒå›´ï¼š</span>
                            <span id="dataTimeRange" class="font-semibold">-</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- æé—®è®¾ç½®éƒ¨åˆ†ï¼ˆé»˜è®¤éšè—ï¼‰ -->
            <div id="questionSection" class="hidden">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">æé—®è®¾ç½®</h3>
                <form id="analysisForm">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">é€‰æ‹©æŒ‡æ ‡ï¼ˆå¯é€‰ï¼‰</label>
                        <select id="indicatorSelect" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                            <option value="">å…¨éƒ¨æŒ‡æ ‡ï¼ˆåˆ†ææ‰€æœ‰æ•°æ®ï¼‰</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-1">é€‰æ‹©å…·ä½“æŒ‡æ ‡åï¼Œåˆ†æå°†é’ˆå¯¹è¯¥æŒ‡æ ‡è¿›è¡Œï¼Œæ›´ç²¾å‡†</p>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">é€‰æ‹©é¢„è®¾é—®é¢˜</label>
                        <select id="presetQuestion" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                            <option value="">è¯·é€‰æ‹©é¢„è®¾é—®é¢˜ï¼ˆå¯é€‰ï¼‰</option>
                            <option value="trend">åˆ†æè¯¥æ•°æ®çš„æ•´ä½“è¶‹åŠ¿</option>
                            <option value="comparison">å¯¹æ¯”ä¸åŒåœ°åŒº/æŒ‡æ ‡çš„æ•°æ®å·®å¼‚</option>
                            <option value="anomaly">è¯†åˆ«æ•°æ®ä¸­çš„å¼‚å¸¸æƒ…å†µ</option>
                            <option value="forecast">é¢„æµ‹æœªæ¥å‘å±•è¶‹åŠ¿</option>
                            <option value="policy">åŸºäºæ•°æ®æå‡ºæ”¿ç­–å»ºè®®</option>
                            <option value="optimization">ä¼˜åŒ–èµ„æºé…ç½®å»ºè®®</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-1">é€‰æ‹©é¢„è®¾é—®é¢˜åï¼Œå¯ä»¥åœ¨æ­¤åŸºç¡€ä¸Šä¿®æ”¹æˆ–è¡¥å……</p>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">è‡ªå®šä¹‰é—®é¢˜</label>
                        <textarea id="customQuestion" rows="4" placeholder="è¯·è¾“å…¥æ‚¨çš„é—®é¢˜ï¼Œä¾‹å¦‚ï¼šåˆ†ææ¹–åŒ—çœå„åœ°åŒºç”Ÿäº§æ€»å€¼çš„å‘å±•è¶‹åŠ¿ï¼Œå¹¶æå‡ºå‘å±•å»ºè®®..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"></textarea>
                        <p class="text-xs text-gray-500 mt-1">å¯ä»¥è¾“å…¥å…·ä½“çš„é—®é¢˜ï¼Œç³»ç»Ÿå°†åŸºäºæ‰€é€‰æ•°æ®å’ŒæŒ‡æ ‡è¿›è¡Œåˆ†æ</p>
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button type="button" id="resetBtn" class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">é‡ç½®</button>
                        <button type="submit" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">å¼€å§‹åˆ†æ</button>
                    </div>
                </form>
                
                <!-- åˆ†æè¯´æ˜ -->
                <div class="mt-6 pt-6 border-t border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-800 mb-2">åˆ†æè¯´æ˜</h3>
                    <div id="analysisInfo" class="text-sm text-gray-600">
                        <p class="text-gray-500">ç³»ç»Ÿå°†åŸºäºæ‚¨é€‰æ‹©çš„æ•°æ®å’Œé—®é¢˜ï¼Œä½¿ç”¨AIå¤§æ¨¡å‹è¿›è¡Œæ·±åº¦åˆ†æï¼Œæä¾›æ•°æ®æ´å¯Ÿå’Œå†³ç­–å»ºè®®ã€‚åˆ†æç»“æœå°†åŒ…æ‹¬æ•°æ®è¶‹åŠ¿ã€å¼‚å¸¸è¯†åˆ«ã€å¯¹æ¯”åˆ†æå’Œæ”¿ç­–å»ºè®®ç­‰å†…å®¹ã€‚</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- åˆ†æç»“æœåŒºåŸŸ -->
        <div id="analysisResults" class="hidden space-y-6">
            <!-- åˆ†ææŠ¥å‘Š -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-800">å†³ç­–åˆ†ææŠ¥å‘Š</h2>
                    <button id="exportReportBtn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm">
                        å¯¼å‡ºæŠ¥å‘Š
                    </button>
                </div>
                <div id="analysisReport" class="prose max-w-none">
                    <div class="text-center py-8">
                        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
                        <p class="mt-4 text-gray-600">æ­£åœ¨åˆ†æä¸­ï¼Œè¯·ç¨å€™...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ç©ºçŠ¶æ€æç¤º -->
        <div id="emptyState" class="bg-white rounded-lg shadow-md p-12 text-center">
            <div class="text-6xl mb-4">ğŸ’¡</div>
            <h3 class="text-xl font-semibold text-gray-800 mb-2">å¼€å§‹å†³ç­–åˆ†æ</h3>
            <p class="text-gray-600 mb-6">è¯·å…ˆé€‰æ‹©æ•°æ®æ–‡ä»¶ï¼Œç„¶åè¾“å…¥æ‚¨çš„é—®é¢˜ï¼Œç³»ç»Ÿå°†ä¸ºæ‚¨æä¾›ä¸“ä¸šçš„å†³ç­–åˆ†æ</p>
        </div>
    </div>

    <!-- Footer -->
    <div id="footer"></div>

    <script type="module">
        import api from '../utils/api.js';
        import auth from '../utils/auth.js';
        import header from '../components/header.js';
        import backButton from '../components/backButton.js';
        import footer from '../components/footer.js';
        import common from '../utils/common.js';

        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        const router = await import('../utils/router.js');
        router.default.beforeEnter('analysis');
        header.initHeader();
        backButton.initBackButton('backButtonContainer');
        footer.initFooter();

        let currentDataFile = null;
        let currentDataStats = null;
        let currentAnalysisResult = null;

        // é¢„è®¾é—®é¢˜æ¨¡æ¿ï¼ˆä¼šæ ¹æ®é€‰ä¸­çš„æŒ‡æ ‡åŠ¨æ€è°ƒæ•´ï¼‰
        const getPresetQuestion = (presetType, indicator) => {
            const indicatorText = indicator ? `é’ˆå¯¹"${indicator}"è¿™ä¸ªæŒ‡æ ‡ï¼Œ` : '';
            
            const templates = {
                'trend': `${indicatorText}è¯·åˆ†æè¯¥æ•°æ®çš„æ•´ä½“å‘å±•è¶‹åŠ¿ï¼ŒåŒ…æ‹¬å¢é•¿è¶‹åŠ¿ã€æ³¢åŠ¨æƒ…å†µã€å‘¨æœŸæ€§ç‰¹å¾ç­‰ï¼Œå¹¶è¯´æ˜å¯èƒ½çš„å½±å“å› ç´ ã€‚`,
                'comparison': `${indicatorText}è¯·å¯¹æ¯”åˆ†æä¸åŒåœ°åŒºæˆ–ä¸åŒæŒ‡æ ‡ä¹‹é—´çš„æ•°æ®å·®å¼‚ï¼Œè¯†åˆ«ä¼˜åŠ¿åŒºåŸŸå’Œéœ€è¦æ”¹è¿›çš„åŒºåŸŸï¼Œå¹¶åˆ†æå·®å¼‚åŸå› ã€‚`,
                'anomaly': `${indicatorText}è¯·è¯†åˆ«æ•°æ®ä¸­çš„å¼‚å¸¸å€¼æˆ–å¼‚å¸¸æ¨¡å¼ï¼Œåˆ†æå¼‚å¸¸äº§ç”Ÿçš„åŸå› ï¼Œå¹¶è¯„ä¼°å¯¹æ•´ä½“æ•°æ®çš„å½±å“ã€‚`,
                'forecast': `${indicatorText}åŸºäºå†å²æ•°æ®ï¼Œé¢„æµ‹æœªæ¥å‘å±•è¶‹åŠ¿ï¼Œå¹¶åˆ†æå¯èƒ½çš„é£é™©å’Œæœºé‡ã€‚`,
                'policy': `${indicatorText}åŸºäºæ•°æ®åˆ†æç»“æœï¼Œæå‡ºé’ˆå¯¹æ€§çš„æ”¿ç­–å»ºè®®å’Œæªæ–½ï¼ŒåŒ…æ‹¬çŸ­æœŸå’Œé•¿æœŸå»ºè®®ã€‚`,
                'optimization': `${indicatorText}åˆ†æèµ„æºé…ç½®æƒ…å†µï¼Œæå‡ºä¼˜åŒ–èµ„æºé…ç½®çš„å»ºè®®ï¼Œä»¥æé«˜æ•´ä½“æ•ˆç›Šã€‚`
            };
            
            return templates[presetType] || '';
        };

        // åŠ è½½å¯ç”¨çš„æ•°æ®æ–‡ä»¶åˆ—è¡¨
        const loadDataFiles = async () => {
            try {
                const response = await api.get('/local-data/files');
                if (response.success && response.data) {
                    const select = document.getElementById('dataFileSelect');
                    select.innerHTML = '<option value="" disabled selected>è¯·é€‰æ‹©æ•°æ®æ–‡ä»¶</option>';
                    
                    response.data.forEach(file => {
                        const option = document.createElement('option');
                        option.value = file.filename;
                        option.textContent = file.name;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('åŠ è½½æ•°æ®æ–‡ä»¶åˆ—è¡¨å¤±è´¥:', error);
                common.showMessage('åŠ è½½æ•°æ®æ–‡ä»¶åˆ—è¡¨å¤±è´¥: ' + error.message, 'error');
            }
        };

        // åŠ è½½æ•°æ®æ–‡ä»¶ç»Ÿè®¡ä¿¡æ¯
        const loadDataStatistics = async (filename) => {
            try {
                const response = await api.get(`/local-data/${encodeURIComponent(filename)}/statistics`);
                if (response.success && response.data) {
                    currentDataStats = response.data;
                    
                    // æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
                    document.getElementById('dataTotal').textContent = currentDataStats.total || '-';
                    document.getElementById('dataAreas').textContent = currentDataStats.areas?.length || '-';
                    document.getElementById('dataIndicators').textContent = currentDataStats.indicators?.length || '-';
                    document.getElementById('dataTimeRange').textContent = currentDataStats.timeRange || '-';
                    
                    // æ›´æ–°æŒ‡æ ‡ä¸‹æ‹‰æ¡†
                    updateIndicatorOptions();
                    
                    document.getElementById('dataFileInfo').classList.remove('hidden');
                    document.getElementById('questionSection').classList.remove('hidden');
                }
            } catch (error) {
                console.error('åŠ è½½æ•°æ®ç»Ÿè®¡å¤±è´¥:', error);
                common.showMessage('åŠ è½½æ•°æ®ç»Ÿè®¡å¤±è´¥: ' + error.message, 'error');
            }
        };

        // æ›´æ–°æŒ‡æ ‡ä¸‹æ‹‰æ¡†é€‰é¡¹
        const updateIndicatorOptions = () => {
            if (!currentDataStats) return;
            
            const indicatorSelect = document.getElementById('indicatorSelect');
            indicatorSelect.innerHTML = '<option value="">å…¨éƒ¨æŒ‡æ ‡ï¼ˆåˆ†ææ‰€æœ‰æ•°æ®ï¼‰</option>';
            
            if (currentDataStats.indicators && currentDataStats.indicators.length > 0) {
                currentDataStats.indicators.forEach((indicator) => {
                    const option = document.createElement('option');
                    option.value = indicator;
                    option.textContent = indicator;
                    indicatorSelect.appendChild(option);
                });
            }
        };

        // æ•°æ®æ–‡ä»¶é€‰æ‹©å˜åŒ–äº‹ä»¶
        document.getElementById('dataFileSelect').addEventListener('change', async (e) => {
            const filename = e.target.value;
            if (filename) {
                currentDataFile = filename;
                await loadDataStatistics(filename);
            } else {
                currentDataFile = null;
                currentDataStats = null;
                document.getElementById('dataFileInfo').classList.add('hidden');
                document.getElementById('questionSection').classList.add('hidden');
                // æ¸…ç©ºæŒ‡æ ‡é€‰æ‹©
                document.getElementById('indicatorSelect').innerHTML = '<option value="">å…¨éƒ¨æŒ‡æ ‡ï¼ˆåˆ†ææ‰€æœ‰æ•°æ®ï¼‰</option>';
            }
        });

        // é¢„è®¾é—®é¢˜é€‰æ‹©å˜åŒ–äº‹ä»¶
        document.getElementById('presetQuestion').addEventListener('change', (e) => {
            const presetValue = e.target.value;
            const customQuestion = document.getElementById('customQuestion');
            const indicator = document.getElementById('indicatorSelect').value;
            
            if (presetValue) {
                customQuestion.value = getPresetQuestion(presetValue, indicator);
            } else {
                customQuestion.value = '';
            }
        });

        // æŒ‡æ ‡é€‰æ‹©å˜åŒ–äº‹ä»¶ï¼ˆæ›´æ–°é¢„è®¾é—®é¢˜ï¼‰
        document.getElementById('indicatorSelect').addEventListener('change', (e) => {
            const presetValue = document.getElementById('presetQuestion').value;
            const customQuestion = document.getElementById('customQuestion');
            
            // å¦‚æœå·²é€‰æ‹©é¢„è®¾é—®é¢˜ï¼Œæ›´æ–°é—®é¢˜å†…å®¹
            if (presetValue) {
                const indicator = e.target.value;
                customQuestion.value = getPresetQuestion(presetValue, indicator);
            }
        });

        // æ‰§è¡Œåˆ†æ
        const performAnalysis = async () => {
            if (!currentDataFile) {
                common.showMessage('è¯·å…ˆé€‰æ‹©æ•°æ®æ–‡ä»¶', 'error');
                return;
            }

            const presetQuestion = document.getElementById('presetQuestion').value;
            const customQuestion = document.getElementById('customQuestion').value.trim();

            if (!customQuestion) {
                common.showMessage('è¯·è¾“å…¥é—®é¢˜', 'error');
                return;
            }

            try {
                // æ˜¾ç¤ºåˆ†æç»“æœåŒºåŸŸ
                document.getElementById('emptyState').classList.add('hidden');
                document.getElementById('analysisResults').classList.remove('hidden');
                
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                const reportDiv = document.getElementById('analysisReport');
                reportDiv.innerHTML = `
                    <div class="text-center py-8">
                        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
                        <p class="mt-4 text-gray-600">æ­£åœ¨åˆ†æä¸­ï¼Œè¯·ç¨å€™...</p>
                    </div>
                `;

                // è·å–é€‰ä¸­çš„æŒ‡æ ‡
                const selectedIndicator = document.getElementById('indicatorSelect').value;

                // è°ƒç”¨åˆ†ææ¥å£
                const response = await api.post('/analysis/analyze', {
                    filename: currentDataFile,
                    indicator: selectedIndicator || null,
                    question: customQuestion,
                    presetType: presetQuestion || null
                });

                if (response.success && response.data) {
                    currentAnalysisResult = response.data;
                    renderAnalysisResult(response.data);
                } else {
                    throw new Error(response.message || 'åˆ†æå¤±è´¥');
                }
            } catch (error) {
                console.error('åˆ†æå¤±è´¥:', error);
                common.showMessage('åˆ†æå¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'), 'error');
                const reportDiv = document.getElementById('analysisReport');
                reportDiv.innerHTML = `
                    <div class="text-center py-8">
                        <div class="text-4xl mb-4">âŒ</div>
                        <p class="text-lg font-semibold text-gray-800 mb-2">åˆ†æå¤±è´¥</p>
                        <p class="text-gray-600">${error.message || 'æœªçŸ¥é”™è¯¯'}</p>
                    </div>
                `;
            }
        };

        // æ¸²æŸ“åˆ†æç»“æœ
        const renderAnalysisResult = (data) => {
            const reportDiv = document.getElementById('analysisReport');
            
            if (!data || !data.analysis) {
                reportDiv.innerHTML = '<p class="text-gray-500">æš‚æ— åˆ†æç»“æœ</p>';
                return;
            }

            // å°†åˆ†æç»“æœæ ¼å¼åŒ–ä¸ºHTML
            let html = '';
            
            // å¦‚æœæœ‰æ ‡é¢˜
            if (data.title) {
                html += `<h2 class="text-2xl font-bold text-gray-800 mb-4">${data.title}</h2>`;
            }
            
            // åˆ†æå†…å®¹ï¼ˆæ”¯æŒMarkdownæ ¼å¼ï¼‰
            const analysisText = data.analysis || '';
            
            // ç®€å•çš„Markdownè½¬HTMLï¼ˆåŸºç¡€æ”¯æŒï¼‰
            let formattedText = analysisText
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, '<br>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/### (.*?)(<br>|$)/g, '<h3 class="text-xl font-semibold text-gray-800 mt-6 mb-3">$1</h3>')
                .replace(/## (.*?)(<br>|$)/g, '<h2 class="text-2xl font-bold text-gray-800 mt-6 mb-4">$1</h2>')
                .replace(/# (.*?)(<br>|$)/g, '<h1 class="text-3xl font-bold text-gray-800 mt-6 mb-4">$1</h1>');
            
            html += `<div class="text-gray-700 leading-relaxed"><p>${formattedText}</p></div>`;
            
            // å¦‚æœæœ‰å»ºè®®
            if (data.recommendations && data.recommendations.length > 0) {
                html += '<div class="mt-8 pt-6 border-t border-gray-200">';
                html += '<h3 class="text-xl font-semibold text-gray-800 mb-4">å†³ç­–å»ºè®®</h3>';
                html += '<ul class="space-y-3">';
                data.recommendations.forEach((rec, index) => {
                    html += `<li class="flex items-start">
                        <span class="flex-shrink-0 w-6 h-6 bg-indigo-600 rounded-full flex items-center justify-center text-white text-sm font-bold mr-3 mt-1">${index + 1}</span>
                        <span class="text-gray-700">${rec}</span>
                    </li>`;
                });
                html += '</ul></div>';
            }
            
            // å¦‚æœæœ‰æ•°æ®æ‘˜è¦
            if (data.summary) {
                html += '<div class="mt-8 pt-6 border-t border-gray-200">';
                html += '<h3 class="text-xl font-semibold text-gray-800 mb-4">æ•°æ®æ‘˜è¦</h3>';
                html += `<div class="bg-gray-50 rounded-lg p-4 text-sm text-gray-600">${data.summary}</div>`;
                html += '</div>';
            }
            
            reportDiv.innerHTML = html;
        };

        // å¯¼å‡ºæŠ¥å‘Š
        document.getElementById('exportReportBtn')?.addEventListener('click', () => {
            if (!currentAnalysisResult) {
                common.showMessage('æ²¡æœ‰å¯å¯¼å‡ºçš„åˆ†æç»“æœ', 'error');
                return;
            }
            
            // ç”ŸæˆæŠ¥å‘Šå†…å®¹
            let content = 'å†³ç­–åˆ†ææŠ¥å‘Š\n';
            content += '='.repeat(50) + '\n\n';
            content += `ç”Ÿæˆæ—¶é—´: ${new Date().toLocaleString('zh-CN')}\n`;
            content += `æ•°æ®æ–‡ä»¶: ${currentDataFile}\n\n`;
            
            if (currentAnalysisResult.title) {
                content += `${currentAnalysisResult.title}\n`;
                content += '-'.repeat(50) + '\n\n';
            }
            
            if (currentAnalysisResult.analysis) {
                content += currentAnalysisResult.analysis + '\n\n';
            }
            
            if (currentAnalysisResult.recommendations && currentAnalysisResult.recommendations.length > 0) {
                content += 'å†³ç­–å»ºè®®\n';
                content += '-'.repeat(50) + '\n';
                currentAnalysisResult.recommendations.forEach((rec, index) => {
                    content += `${index + 1}. ${rec}\n`;
                });
                content += '\n';
            }
            
            if (currentAnalysisResult.summary) {
                content += 'æ•°æ®æ‘˜è¦\n';
                content += '-'.repeat(50) + '\n';
                content += currentAnalysisResult.summary + '\n';
            }
            
            // åˆ›å»ºå¹¶ä¸‹è½½æ–‡ä»¶
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `å†³ç­–åˆ†ææŠ¥å‘Š_${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            common.showMessage('æŠ¥å‘Šå¯¼å‡ºæˆåŠŸ', 'success');
        });

        // è¡¨å•æäº¤
        document.getElementById('analysisForm').addEventListener('submit', (e) => {
            e.preventDefault();
            performAnalysis();
        });

        // é‡ç½®æŒ‰é’®
        document.getElementById('resetBtn').addEventListener('click', () => {
            document.getElementById('indicatorSelect').value = '';
            document.getElementById('presetQuestion').value = '';
            document.getElementById('customQuestion').value = '';
            document.getElementById('analysisResults').classList.add('hidden');
            document.getElementById('emptyState').classList.remove('hidden');
            currentAnalysisResult = null;
        });

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        loadDataFiles();
    </script>
</body>
</html>
