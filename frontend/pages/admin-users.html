<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”¨æˆ·ç®¡ç† - æ•°æ™ºæ¹–åŒ—</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="../public/css/common.css">
    <link rel="stylesheet" href="../public/css/components.css">
    <link rel="stylesheet" href="../public/css/footer.css">
</head>
<body class="bg-gray-50">
    <div id="header"></div>
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- è¿”å›é¦–é¡µæŒ‰é’® -->
        <div id="backButtonContainer"></div>
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex justify-between items-center mb-4">
                <h1 class="text-2xl font-bold text-indigo-600">ç”¨æˆ·ç®¡ç†</h1>
                <button id="createUserBtn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">åˆ›å»ºç”¨æˆ·</button>
            </div>
        </div>
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ç”¨æˆ·è§’è‰²</label>
                    <select id="roleFilter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        <option>å…¨éƒ¨è§’è‰²</option>
                        <option>æ™®é€šç”¨æˆ·</option>
                        <option>å†³ç­–ç”¨æˆ·</option>
                        <option>ç®¡ç†å‘˜</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">è´¦æˆ·çŠ¶æ€</label>
                    <select id="statusFilter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        <option>å…¨éƒ¨çŠ¶æ€</option>
                        <option>æ­£å¸¸</option>
                        <option>å·²ç¦ç”¨</option>
                        <option>å·²æ³¨é”€</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">æ³¨å†Œæ—¶é—´</label>
                    <select id="timeFilter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        <option>å…¨éƒ¨æ—¶é—´</option>
                        <option>æœ€è¿‘7å¤©</option>
                        <option>æœ€è¿‘30å¤©</option>
                        <option>æœ€è¿‘90å¤©</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">æœç´¢</label>
                    <input type="text" id="searchInput" placeholder="æœç´¢ç”¨æˆ·å/é‚®ç®±..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                </div>
            </div>
            <div class="flex justify-between items-center">
                <div class="flex space-x-3">
                    <button id="batchEnableBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">æ‰¹é‡å¯ç”¨</button>
                    <button id="batchDisableBtn" class="px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700">æ‰¹é‡ç¦ç”¨</button>
                    <button id="batchDeleteBtn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">æ‰¹é‡åˆ é™¤</button>
                </div>
                <div class="flex space-x-3">
                    <button id="resetBtn" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">é‡ç½®</button>
                    <button id="queryBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">æŸ¥è¯¢</button>
                </div>
            </div>
        </div>
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-semibold text-gray-800">ç”¨æˆ·åˆ—è¡¨</h2>
                <div class="flex items-center space-x-4">
                    <span class="text-sm text-gray-600">å…± <span id="totalCount" class="font-semibold text-indigo-600">0</span> ä¸ªç”¨æˆ·</span>
                    <select id="pageSize" class="px-3 py-1 border border-gray-300 rounded text-sm">
                        <option value="20">æ¯é¡µ20æ¡</option>
                        <option value="50">æ¯é¡µ50æ¡</option>
                        <option value="100">æ¯é¡µ100æ¡</option>
                    </select>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left"><input type="checkbox" id="selectAll" class="rounded border-gray-300"></th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ç”¨æˆ·å</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">é‚®ç®±</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">è§’è‰²</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">çŠ¶æ€</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ³¨å†Œæ—¶é—´</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æœ€åç™»å½•</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="userTableBody" class="bg-white divide-y divide-gray-200"></tbody>
                </table>
            </div>
            <div id="pagination" class="mt-6 flex items-center justify-between"></div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600 mb-1">æ€»ç”¨æˆ·æ•°</p>
                        <p id="totalUsers" class="text-2xl font-bold text-gray-800">0</p>
                    </div>
                    <div class="text-3xl text-blue-500">ğŸ‘¥</div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600 mb-1">æ™®é€šç”¨æˆ·</p>
                        <p id="normalUsers" class="text-2xl font-bold text-blue-600">0</p>
                    </div>
                    <div class="text-3xl text-blue-500">ğŸ‘¤</div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600 mb-1">å†³ç­–ç”¨æˆ·</p>
                        <p id="decisionUsers" class="text-2xl font-bold text-purple-600">0</p>
                    </div>
                    <div class="text-3xl text-purple-500">ğŸ’¼</div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600 mb-1">ç®¡ç†å‘˜</p>
                        <p id="adminUsers" class="text-2xl font-bold text-indigo-600">0</p>
                    </div>
                    <div class="text-3xl text-indigo-500">ğŸ”‘</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div id="footer"></div>

    <script type="module">
        import api from '../utils/api.js';
        import auth from '../utils/auth.js';
        import header from '../components/header.js';
        import common from '../utils/common.js';
        import backButton from '../components/backButton.js';
        import footer from '../components/footer.js';
        // æ£€æŸ¥ç™»å½•çŠ¶æ€å’Œæƒé™ï¼ˆä½¿ç”¨è·¯ç”±å®ˆå«ï¼‰
        const router = await import('../utils/router.js');
        router.default.beforeEnter('adminUsers');
        header.initHeader();
        backButton.initBackButton('backButtonContainer');
        footer.initFooter();
        const loadUsers = async () => {
            try {
                const response = await api.get('/user/list', {
                    role: document.getElementById('roleFilter').value,
                    status: document.getElementById('statusFilter').value,
                    time: document.getElementById('timeFilter').value,
                    keyword: document.getElementById('searchInput').value
                });
                if (response.success) {
                    renderTable(response.data || []);
                    updateStats(response.stats || {});
                }
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·å¤±è´¥:', error);
            }
        };
        const renderTable = (users) => {
            const tbody = document.getElementById('userTableBody');
            const roleMap = { 'admin': 'ç®¡ç†å‘˜', 'decision_user': 'å†³ç­–ç”¨æˆ·', 'normal_user': 'æ™®é€šç”¨æˆ·' };
            const roleColorMap = { 'admin': 'indigo', 'decision_user': 'purple', 'normal_user': 'blue' };
            tbody.innerHTML = users.map(user => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap"><input type="checkbox" class="user-checkbox rounded border-gray-300" value="${user.id}"></td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="w-10 h-10 bg-${roleColorMap[user.role] || 'indigo'}-600 rounded-full flex items-center justify-center text-white text-sm mr-3">${(user.username || 'ç”¨').charAt(0).toUpperCase()}</div>
                            <div class="text-sm font-medium text-gray-900">${user.username}</div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${user.email}</td>
                    <td class="px-6 py-4 whitespace-nowrap"><span class="px-2 py-1 text-xs font-semibold rounded-full bg-${roleColorMap[user.role] || 'blue'}-100 text-${roleColorMap[user.role] || 'blue'}-800">${roleMap[user.role] || 'æ™®é€šç”¨æˆ·'}</span></td>
                    <td class="px-6 py-4 whitespace-nowrap"><span class="px-2 py-1 text-xs font-semibold rounded-full ${user.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${user.status === 'active' ? 'æ­£å¸¸' : 'å·²ç¦ç”¨'}</span></td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${common.formatDate(user.createdAt)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${common.formatDate(user.lastLogin)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <button class="text-indigo-600 hover:text-indigo-900 mr-3" onclick="editUser('${user.id}')">ç¼–è¾‘</button>
                        ${user.status === 'active' ? '<button class="text-yellow-600 hover:text-yellow-900 mr-3" onclick="disableUser(\'' + user.id + '\')">ç¦ç”¨</button>' : '<button class="text-green-600 hover:text-green-900 mr-3" onclick="enableUser(\'' + user.id + '\')">å¯ç”¨</button>'}
                        <button class="text-red-600 hover:text-red-900" onclick="deleteUser('${user.id}')">åˆ é™¤</button>
                    </td>
                </tr>
            `).join('');
        };
        const updateStats = (stats) => {
            document.getElementById('totalUsers').textContent = stats.total || 0;
            document.getElementById('normalUsers').textContent = stats.normal || 0;
            document.getElementById('decisionUsers').textContent = stats.decision || 0;
            document.getElementById('adminUsers').textContent = stats.admin || 0;
        };
        document.getElementById('queryBtn').addEventListener('click', loadUsers);
        document.getElementById('resetBtn').addEventListener('click', () => {
            document.getElementById('roleFilter').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('timeFilter').value = '';
            document.getElementById('searchInput').value = '';
            loadUsers();
        });
        loadUsers();
    </script>
</body>
</html>

