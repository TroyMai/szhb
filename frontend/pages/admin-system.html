<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç³»ç»Ÿç®¡ç† - æ•°æ™ºæ¹–åŒ—</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="../public/css/common.css">
    <link rel="stylesheet" href="../public/css/components.css">
    <link rel="stylesheet" href="../public/css/footer.css">
</head>
<body class="bg-gray-50">
    <div id="header"></div>
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- è¿”å›é¦–é¡µæŒ‰é’® -->
        <div id="backButtonContainer"></div>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-lg font-semibold text-gray-800 mb-4">æœåŠ¡å™¨çŠ¶æ€</h2>
                <div id="serverStatus" class="space-y-4"></div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-lg font-semibold text-gray-800 mb-4">æ•°æ®åº“çŠ¶æ€</h2>
                <div id="dbStatus" class="space-y-4"></div>
            </div>
        </div>
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-lg font-semibold text-gray-800 mb-4">ç³»ç»Ÿé…ç½®</h2>
            <form id="configForm" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">æ•°æ®è‡ªåŠ¨æ›´æ–°é¢‘ç‡</label>
                        <select id="updateFrequency" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                            <option>æ¯å¤©</option>
                            <option>æ¯å‘¨</option>
                            <option>æ¯æœˆ</option>
                            <option>æ‰‹åŠ¨æ›´æ–°</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">æ•°æ®å¤‡ä»½é¢‘ç‡</label>
                        <select id="backupFrequency" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                            <option>æ¯å¤©</option>
                            <option>æ¯å‘¨</option>
                            <option>æ¯æœˆ</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ä¼šè¯è¶…æ—¶æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰</label>
                        <input type="number" id="sessionTimeout" value="30" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">æœ€å¤§å¹¶å‘ç”¨æˆ·æ•°</label>
                        <input type="number" id="maxUsers" value="500" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <label class="flex items-center">
                        <input type="checkbox" id="httpsEnabled" checked class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                        <span class="ml-2 text-sm text-gray-700">å¯ç”¨HTTPSåŠ å¯†ä¼ è¾“</span>
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" id="twoFactorEnabled" checked class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                        <span class="ml-2 text-sm text-gray-700">å¯ç”¨åŒå› ç´ è®¤è¯</span>
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" id="alertEnabled" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                        <span class="ml-2 text-sm text-gray-700">å¯ç”¨å¼‚å¸¸ç™»å½•å‘Šè­¦</span>
                    </label>
                </div>
                <div class="flex justify-end">
                    <button type="submit" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">ä¿å­˜é…ç½®</button>
                </div>
            </form>
        </div>
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-lg font-semibold text-gray-800 mb-4">ç³»ç»Ÿæ—¥å¿—</h2>
            <div class="mb-4 flex items-center space-x-4">
                <select id="logTypeFilter" class="px-4 py-2 border border-gray-300 rounded-lg text-sm">
                    <option>å…¨éƒ¨æ—¥å¿—</option>
                    <option>ç™»å½•æ—¥å¿—</option>
                    <option>æ“ä½œæ—¥å¿—</option>
                    <option>é”™è¯¯æ—¥å¿—</option>
                    <option>ç³»ç»Ÿæ—¥å¿—</option>
                </select>
                <input type="date" id="logDate" class="px-4 py-2 border border-gray-300 rounded-lg text-sm">
                <button id="queryLogsBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 text-sm">æŸ¥è¯¢</button>
                <button id="exportLogsBtn" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 text-sm">å¯¼å‡ºæ—¥å¿—</button>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ—¶é—´</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ç±»å‹</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ç”¨æˆ·</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ“ä½œ</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">IPåœ°å€</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">çŠ¶æ€</th>
                        </tr>
                    </thead>
                    <tbody id="logsTableBody" class="bg-white divide-y divide-gray-200"></tbody>
                </table>
            </div>
            <div id="logsPagination" class="mt-4 flex items-center justify-between"></div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600 mb-1">åœ¨çº¿ç”¨æˆ·</p>
                        <p id="onlineUsers" class="text-2xl font-bold text-green-600">0</p>
                    </div>
                    <div class="text-3xl text-green-500">ğŸŸ¢</div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600 mb-1">ä»Šæ—¥è®¿é—®é‡</p>
                        <p id="todayVisits" class="text-2xl font-bold text-blue-600">0</p>
                    </div>
                    <div class="text-3xl text-blue-500">ğŸ“Š</div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600 mb-1">ç³»ç»Ÿè¿è¡Œæ—¶é—´</p>
                        <p id="uptime" class="text-2xl font-bold text-purple-600">0å¤©</p>
                    </div>
                    <div class="text-3xl text-purple-500">â±ï¸</div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600 mb-1">é”™è¯¯ç‡</p>
                        <p id="errorRate" class="text-2xl font-bold text-red-600">0%</p>
                    </div>
                    <div class="text-3xl text-red-500">âš ï¸</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div id="footer"></div>

    <script type="module">
        import api from '../utils/api.js';
        import auth from '../utils/auth.js';
        import header from '../components/header.js';
        import common from '../utils/common.js';
        import backButton from '../components/backButton.js';
        import footer from '../components/footer.js';
        // æ£€æŸ¥ç™»å½•çŠ¶æ€å’Œæƒé™ï¼ˆä½¿ç”¨è·¯ç”±å®ˆå«ï¼‰
        const router = await import('../utils/router.js');
        router.default.beforeEnter('adminSystem');
        header.initHeader();
        backButton.initBackButton('backButtonContainer');
        footer.initFooter();
        const loadSystemStatus = async () => {
            try {
                const response = await api.get('/system/status');
                if (response.success && response.data) {
                    const status = response.data;
                    document.getElementById('serverStatus').innerHTML = `
                        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                            <div class="flex items-center"><div class="w-3 h-3 bg-green-500 rounded-full mr-3"></div><span class="text-gray-700">CPU ä½¿ç”¨ç‡</span></div>
                            <div class="flex items-center space-x-3"><div class="w-32 bg-gray-200 rounded-full h-2"><div class="bg-green-500 h-2 rounded-full" style="width: ${status.cpu || 45}%"></div></div><span class="text-sm font-semibold text-gray-800">${status.cpu || 45}%</span></div>
                        </div>
                        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                            <div class="flex items-center"><div class="w-3 h-3 bg-green-500 rounded-full mr-3"></div><span class="text-gray-700">å†…å­˜ä½¿ç”¨ç‡</span></div>
                            <div class="flex items-center space-x-3"><div class="w-32 bg-gray-200 rounded-full h-2"><div class="bg-green-500 h-2 rounded-full" style="width: ${status.memory || 62}%"></div></div><span class="text-sm font-semibold text-gray-800">${status.memory || 62}%</span></div>
                        </div>
                    `;
                    document.getElementById('onlineUsers').textContent = status.onlineUsers || 0;
                    document.getElementById('todayVisits').textContent = status.todayVisits || 0;
                    document.getElementById('uptime').textContent = status.uptime || '0å¤©';
                    document.getElementById('errorRate').textContent = status.errorRate || '0%';
                }
            } catch (error) {
                console.error('åŠ è½½ç³»ç»ŸçŠ¶æ€å¤±è´¥:', error);
            }
        };
        const loadLogs = async () => {
            try {
                const response = await api.get('/system/logs', {
                    type: document.getElementById('logTypeFilter').value,
                    date: document.getElementById('logDate').value
                });
                if (response.success) {
                    renderLogs(response.data || []);
                }
            } catch (error) {
                console.error('åŠ è½½æ—¥å¿—å¤±è´¥:', error);
            }
        };
        const renderLogs = (logs) => {
            const tbody = document.getElementById('logsTableBody');
            const typeColorMap = { 'login': 'green', 'operation': 'blue', 'error': 'red', 'system': 'yellow' };
            tbody.innerHTML = logs.map(log => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${common.formatDate(log.time)}</td>
                    <td class="px-6 py-4 whitespace-nowrap"><span class="px-2 py-1 text-xs font-semibold rounded-full bg-${typeColorMap[log.type] || 'blue'}-100 text-${typeColorMap[log.type] || 'blue'}-800">${log.type}</span></td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${log.user || 'ç³»ç»Ÿ'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${log.action}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${log.ip || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap"><span class="px-2 py-1 text-xs font-semibold rounded-full ${log.status === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${log.status === 'success' ? 'æˆåŠŸ' : 'å¤±è´¥'}</span></td>
                </tr>
            `).join('');
        };
        document.getElementById('configForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const response = await api.post('/system/config', {
                    updateFrequency: document.getElementById('updateFrequency').value,
                    backupFrequency: document.getElementById('backupFrequency').value,
                    sessionTimeout: document.getElementById('sessionTimeout').value,
                    maxUsers: document.getElementById('maxUsers').value,
                    httpsEnabled: document.getElementById('httpsEnabled').checked,
                    twoFactorEnabled: document.getElementById('twoFactorEnabled').checked,
                    alertEnabled: document.getElementById('alertEnabled').checked
                });
                if (response.success) {
                    common.showMessage('é…ç½®ä¿å­˜æˆåŠŸ', 'success');
                }
            } catch (error) {
                common.showMessage('é…ç½®ä¿å­˜å¤±è´¥', 'error');
            }
        });
        document.getElementById('queryLogsBtn').addEventListener('click', loadLogs);
        document.getElementById('exportLogsBtn').addEventListener('click', async () => {
            try {
                const response = await api.get('/system/logs/export');
                if (response.success) {
                    common.showMessage('æ—¥å¿—å¯¼å‡ºæˆåŠŸ', 'success');
                }
            } catch (error) {
                common.showMessage('æ—¥å¿—å¯¼å‡ºå¤±è´¥', 'error');
            }
        });
        loadSystemStatus();
        loadLogs();
        setInterval(loadSystemStatus, 30000);
    </script>
</body>
</html>

